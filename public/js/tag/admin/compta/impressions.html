<impressions>
    <!--<div id="titre_page"><h1>Impressions</h1></div>-->
    <div if={ COMPTA_READ } class="content with_submenu">
        <span class="hidden" id="entrepriseName"></span>
        <div class="impression_letf_right">
            <div class="left_impression">
                <img class="hidden" id="logo_entreprise" src="">
                <span class="hidden" id="exerciceName">Exercice : { nom_exercice }</span>
            </div>
            <div class="right_impression">
                <span class="hidden filtreName">Filtre(s) :  </span>
                <textarea class="hidden" id="filtres_print" rows="7">{ tactac }</textarea>
            </div>
        </div>
        <div class="compta compta_impressions">
            <div class="block-filtre block-slider">
                <header class="filtre-header center opened header-title" onclick= { showContents }>
                    Filtres
                </header>
                <div class="slide-up hidden">
                    <div class="line-separator"></div>
                    <div class="filtre">
                    </div>
                </div>
            </div>   
            <div if={ COMPTA_READ } class="nav_compta_impressions block-slider">
                <header class="closed" id="head_print" onclick= { showContents }>
                    <span class="comptes-title_ center" onclick={ showComptaGenerale }>
                        Comptabilité Générale 
                    </span>
                </header>
                <div class="slide-up" id="show_compta_generale">
                    <div class="line-separator"></div>
                    <div class="compta_content">
                        <div class="impressions_comptagenerale">
                            <div class="table table_impressions_comptagenerale">
                                <div class="row row_impressions_comptagenerale">
                                    <div class="cell cell_impressions_comptagenerale2">
                                        <input id="img_balance_generale" onclick={ Onglet_banlaceGenerale } id-for-uncheck="id_balance_generale" type="checkbox" value="balancegenerale">
                                        <label for="img_balance_generale"></label>
                                    </div>
                                    <div class="cell cell_impressions_comptagenerale1">
                                        <input id="img_grand_livre" onclick={ Onglet_grandLivre } id-for-uncheck="id_grand_livre" type="checkbox" value="grandlivre">
                                        <label for="img_grand_livre"></label>
                                    </div>
                                    <div class="cell cell_impressions_comptagenerale2">
                                        <input id="img_balance_auxiliaire" onclick={ Onglet_banlaceAuxiliare } id-for-uncheck="id_balance_auxiliaire" type="checkbox" value="balance_auxiliaire">
                                        <label for="img_balance_auxiliaire"></label>
                                    </div>
                                    <div class="cell cell_impressions_comptagenerale1">
                                        <input id="img_grand_livre_auxiliaire" onclick={ Onglet_grandLivreAuxiliaire } id-for-uncheck="id_grand_livre_auxiliaire" type="checkbox" value="grandlivre_auxiliaire">
                                        <label for="img_grand_livre_auxiliaire"></label>
                                    </div>
                                    <div class="cell cell_impressions_comptagenerale3">
                                        <input id="img_compte_resultat" onclick={ Onglet_compteResultat } id-for-uncheck="id_compte_resultat" type="checkbox" value="compte_resultat">
                                        <label for="img_compte_resultat"></label>
                                    </div>
                                    <div class="cell cell_impressions_comptagenerale3">
                                        <input id="img_bilan" onclick={ Onglet_bilan } id-for-uncheck="id_bilan" type="checkbox" value="bilan">
                                        <label for="img_bilan"></label>
                                    </div>
                                </div>
                                <div if={ IS_ASSO } class="row row_impressions_comptagenerale">
                                    <div class="cell cell_impressions_comptagenerale1"></div>
                                    <div class="cell cell_impressions_comptagenerale2">
                                        <img src="/img/compta/button_pla.png" alt="pla">
                                    </div>
                                    <div class="cell cell_impressions_comptagenerale3"></div>
                                </div>
                            </div>
                            <div class="nombreEcritures_generale">
                                Nombre d'écritures : { nbr_ecritures }
                            </div>
                        </div>
                        <!-- BALANCE GENERALE -->
                        <div id="balancegenerale2" class="balancegenerale hidden">
                            <div class="table table_impressions_filtres_balancegenerale">
                                <div class="cell_1 button_retour" onclick={ retourPageImpression } value="2">
                                </div>
                                <!-- <div class="cell_2 button_export"></div> -->
                                <a class="cell_2 button_export" href="/admin/compta/export_comptes?format=excel"></a>
                                <div class="cell_3 button_imprimer" id="lance_impression" onclick={ lanceImpression }></div>
                                <!-- <div class="cell_34 hidden"></div> -->
                                <div class="cell_4">
                                    <b>BALANCE GENERALE</b>
                                </div>
                                <div class="cell_5">
                                    Résultat 
                                </div>
                                <div class="cell_6">
                                    Débit <p class="solde_resultat">{ formatNumber(solde_resultat_debit) }</p>
                                </div>
                                <div class="cell_7">
                                    Crédit <p class="solde_resultat_c">{ formatNumber(solde_resultat_credit) }</p>
                                </div>
                            </div>
                            <div class="entete-tableau_1">
                                <div class="cell_1" id="print_hidden">
                                    <input onclick={ comptesMov } type="checkbox" name="comptes_mov">
                                    Uniquement comptes mouvementés
                                </div>
                                <div class="cell_2"></div>
                                <div class="cell_3">Cumuls</div>
                                <div class="cell_4">Solde</div>
                            </div>
                            <div class="entete-tableau entete-tableau-balancegenerale">
                                <div class="cell_1 comptes_vide"></div>
                                <div class="cell_2 libelle_vide"></div>
                                <div class="cell_3">
                                    <div class="debit_credit">
                                        <div class="cell_debit">Débit</div>
                                        <div class="cell_credit">Crédit</div>
                                    </div>
                                </div>
                                <div class="cell_4">
                                    <div class="debit_credit">
                                        <div class="cell_debit">Débit</div>
                                        <div class="cell_credit">Crédit</div>
                                    </div>
                                </div>
                            </div>
                            <div each={ impressions } if={ ! comptesMovChecked || (debit != 0 || credit != 0) }  class="table c100 impression">
                                <div class="show_infos show_classe" onclick={ showSousClasse }>
                                    <div class="cell_1" >Classe { ref_classe } </div>
                                    <div class="cell_2 total_classe">{ libelle_classe }</div>
                                    <div class="cell_3">
                                        <div class="debit_credit">
                                            <div class="cell_debit">{ formatNumber(debit) }</div>
                                            <div class="cell_credit">{ formatNumber(credit) }</div>
                                        </div>
                                    </div>
                                    <div class="cell_4">
                                        <div class="debit_credit">
                                            <div class="cell_debit">{ formatNumber(solde_debit) }</div>
                                            <div class="cell_credit">{ formatNumber(solde_credit) }</div>
                                        </div>
                                    </div>
                                </div>
                                <div each={ sous_classe } if={ ! comptesMovChecked || (debit != 0 || credit != 0) }  class="table c100 sous_classe">
                                    <div class="show_infos show_sous_classe" onclick={ showComptes }>
                                        <div class="cell_1">Sous classe { ref_sous_classe }</div>
                                        <div class="cell_2 total_sous_classe">{ libelle_sous_classe }</div>
                                        <div class="cell_3">
                                            <div class="debit_credit">
                                                <div class="cell_debit">{ formatNumber(debit) }</div>
                                                <div class="cell_credit">{ formatNumber(credit) }</div>
                                            </div>
                                        </div>
                                        <div class="cell_4">
                                            <div class="debit_credit">
                                                <div class="cell_debit">{ formatNumber(solde_debit) }</div>
                                                <div class="cell_credit">{ formatNumber(solde_credit) }</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div each={ comptes } if={ ! comptesMovChecked || (debit != 0 || credit != 0) } class="table c100 comptes"> <!-- if={ (debit != 0 || credit != 0) } -->
                                        <div class="show_infos show_comptes">
                                            <div class="cell_1">{ ref_compte }</div>
                                            <div class="cell_2">{ libelle_compte }</div>
                                            <div class="cell_3">
                                                <div class="debit_credit">
                                                    <div class="cell_debit">{ formatNumber(debit) }</div>
                                                    <div class="cell_credit">{ formatNumber(credit) }</div>
                                                </div>
                                            </div>
                                            <div class="cell_4">
                                                <div class="debit_credit">
                                                    <div class="cell_debit">{ formatNumber(solde_debit) }</div>
                                                    <div class="cell_credit">{ formatNumber(solde_credit) }</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- FIN BALANCE GENERALE -->
                        <!-- GRAND LIVRE -->
                        <div id="ongletgrandlivre2" class="ongletgrandlivre hidden">
                            <div class="table table_grandlivres_filtres_ongletgrandlivre">
                                <div class="cell_1 button_retour" onclick={ retourPageImpression } value="2"></div>
                                <div class="cell_2 button_export"></div>
                                <div class="cell_3 button_imprimer" id="lance_impression" onclick={ lanceImpression }></div>
                                <!-- <div class="cell_34 hidden" style="width:0%"></div> -->
                                <div class="cell_4">
                                    <b>GRAND LIVRE</b>
                                </div>
                                <div class="cell_5"></div>
                                <div class="cell_6"></div>
                                <div class="cell_7"></div>
                            </div>
                            <div class="grandLivreAccountMov"></div>
                            <div class="entete-tableau_1">
                                <div class="cell_1">
                                    <p>Journal</p>
                                    <p>Date</p>
                                </div>
                                <div class="cell_2">
                                    <p>Opération</p>
                                    <p>Pièce</p>
                                </div>
                                <div class="cell_3">Libelle</div>
                                <div class="cell_4">Tiers - Analytique</div>
                                <div class="cell_5">L/R</div>
                                <div class="cell_6">Débit</div>
                                <div class="cell_7">Crédit</div>
                                <div class="cell_8">Solde</div>
                            </div>
                            <div each={ grandlivre } if={ (debit != 0 || credit != 0) } if={ ! GrandLivreComptesMovChecked || (debit != 0 || credit != 0) } class="table c100 tableau-grandlivre">
                                <div class="show_infos show_classe" onclick={ showSousClasse }>
                                    <div class="cell_1" >{ ref_classe } - { libelle_classe }</div>
                                    <div class="cell_2">{ formatNumber(debit) }</div>
                                    <div class="cell_3">{ formatNumber(credit) }</div>
                                    <div class="cell_4">{ formatNumber(solde) }</div>
                                </div>
                                <div each={ sous_classe } if={ (debit != 0 || credit != 0) } if={ ! GrandLivreComptesMovChecked || (debit != 0 || credit != 0) } class="table c100 sous_classe">
                                    <div class="show_infos show_sous_classe" onclick={ showComptes }>
                                        <div class="cell_1">{ ref_sous_classe } - { libelle_sous_classe }</div>
                                        <div class="cell_2">{ formatNumber(debit) }</div>
                                        <div class="cell_3">{ formatNumber(credit) }</div>
                                        <div class="cell_4">{ formatNumber(solde) }</div>
                                    </div>
                                    <div each={ comptes } if={ (debit != 0 || credit != 0) } if={ ! GrandLivreComptesMovChecked || (debit != 0 || credit != 0) } class="table c100 comptes">
                                        <div class="show_infos show_comptes" onclick={ showEcritures }>
                                            <div class="cell_1">{ ref_compte } - { libelle_compte }</div>
                                            <div class="cell_2">{ formatNumber(debit) }</div>
                                            <div class="cell_3">{ formatNumber(credit) }</div>
                                            <div class="cell_4">{ formatNumber(solde) }</div>
                                        </div>
                                        <div each={ ecritures } if={ (debit != 0 || credit != 0) } class="table c100 ecritures">
                                            <div class="show_infos show_ecritures">
                                                <div class="cell_1"><p>{ this.journaux[ this.idJournaux[ id_journal ]].libelle }</p><p>{ formatDate(date_ecriture) }</p></div>
                                                <div class="cell_2"><p>{ operation }</p> <p>{ piece }</p></div>
                                                <div class="cell_3">{ libelle_ecriture }</div>
                                                <div class="cell_4">{ libelle_analytique } { libelle_salarie } { libelle_fournisseur }</div>
                                                <div class="cell_5"></div>
                                                <div class="cell_6">{ formatNumber(debit) }</div>
                                                <div class="cell_7">{ formatNumber(credit) }</div>
                                                <div class="cell_8">{ formatNumber(solde) }</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- FIN GRAND LIVRE -->
                        <!-- BALANCE AUXILIAIRE -->
                        <div id="balanceauxiliaire2" class="balanceauxiliaire hidden">
                            <div class="table sousdiv_balanceauxiliaire">
                                <div class="cell_1 button_retour" onclick={ retourPageImpression } value="2"></div>
                                <div class="cell_2 button_export"></div>
                                <div class="cell_3 button_imprimer" id="lance_impression" onclick={ lanceImpression }></div>
                                <!-- <div class="cell_34 hidden" style="width: 0%"></div> -->
                                <div class="cell_4">
                                    <b>BALANCE AUXILIAIRE</b>
                                </div>
                                <div class="cell_5"></div>
                                <div class="cell_6"></div>
                                <div class="cell_7"></div>
                            </div>
                            <div class="entete-tableau_1">
                                <div class="cell_1">
                                    <input each={ grandlivre_auxiliaire } onclick={ soldeZero } type="checkbox" name="solde_zero">Tous les comptes non soldés
                                </div>
                                <div class="cell_2"></div>
                                <div class="cell_3">Cumuls</div>
                                <div class="cell_4">Solde</div>
                            </div>
                            <div class="entete-tableau entete-tableau-balanceauxiliaire">
                                <div class="cell_1 comptes_vide"></div>
                                <div class="cell_2 libelle_vide"></div>
                                <div class="cell_3">
                                    <div class="debit_credit">
                                        <div class="cell_debit">Débit</div>
                                        <div class="cell_credit">Crédit</div>
                                    </div>
                                </div>
                                <div class="cell_4">
                                    <div class="debit_credit">
                                        <div class="cell_debit">Débit</div>
                                        <div class="cell_credit">Crédit</div>
                                    </div>
                                </div>
                            </div>
                            <div each={ grandlivre_auxiliaire } if={ ! comptesFournisseursSalariesMovChecked || ( debit != 0 || credit != 0) } class="table c100 fournisseurs">
                                <div if={ ! soldeZeroChecked || ( solde_debit != 0 || solde_credit != 0) } class="show_infos show_ba_sous_classe" onclick={ showBaComptes }>
                                    <div class="cell_1" >{ ref_sous_classe }  { libelle_sous_classe }</div>
                                    <div class="cell_2 total_ba_sous_classe"></div>
                                    <div class="cell_3">
                                        <div class="debit_credit">
                                            <div class="cell_debit">{ formatNumber(debit) }</div>
                                            <div class="cell_credit">{ formatNumber(credit) }</div>
                                        </div>
                                    </div>
                                    <div class="cell_4">
                                        <div class="debit_credit">
                                            <div class="cell_debit">{ formatNumber(solde_debit) }</div>
                                            <div class="cell_credit">{ formatNumber(solde_credit) }</div>
                                        </div>
                                    </div>
                                </div>
                                <div each={ bacomptes } if={ ! comptesFournisseursSalariesMovChecked || ( debit != 0 || credit != 0) } class="table c100 ba_comptes">
                                    <div if={ ! soldeZeroChecked || ( solde_debit != 0 || solde_credit != 0) } class="show_infos show_ba_comptes" onclick={ showBaFournisseursSalaries }>
                                        <div id="impression_balance_aux_un" class="cell_1">{ ref_compte } - { libelle_compte }</div>
                                        <div id="impression_balance_aux_deux" class="cell_2 total_ba_comptes"></div>
                                        <div class="cell_3">
                                            <div class="debit_credit">
                                                <div class="cell_debit">{ formatNumber(debit) }</div>
                                                <div class="cell_credit">{ formatNumber(credit) }</div>
                                            </div>
                                        </div>
                                        <div class="cell_4">
                                            <div class="debit_credit">
                                                <div class="cell_debit">{ formatNumber(solde_debit) }</div>
                                                <div class="cell_credit">{ formatNumber(solde_credit) }</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div each={ fournisseur_salarie } if={ ! comptesFournisseursSalariesMovChecked || ( debit != 0 || credit != 0) } class="table c100 ba_fournisseurs_salaries">
                                        <div if={ ! soldeZeroChecked || ( solde_debit != 0 || solde_credit != 0) } class="show_infos show_ba_fournisseurs_salaries">
                                            <div class="cell_1">{ nom_salarie_fournisseur }</div>
                                            <div class="cell_2"></div>
                                            <div class="cell_3">
                                                <div class="debit_credit">
                                                    <div class="cell_debit">{ formatNumber(debit) }</div>
                                                    <div class="cell_credit">{ formatNumber(credit) }</div>
                                                </div>
                                            </div>
                                            <div class="cell_4">
                                                <div class="debit_credit">
                                                    <div class="cell_debit">{ formatNumber(solde_debit) }</div>
                                                    <div class="cell_credit">{ formatNumber(solde_credit) }</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- FIN BALANCE AUXILIAIRE -->
                        <!-- GRAND LIVRE AUXILIAIRE -->
                        <div id="OngletGrandLivreAuxiliaire2" class="OngletGrandLivreAuxiliaire hidden">
                            <div class="table table_Ongletgrandlivreauxiliaire">
                                <div class="cell_1 button_retour" onclick={ retourPageImpression } value="2"></div>
                                <div class="cell_2 button_export"></div>
                                <div class="cell_3 button_imprimer" id="lance_impression" onclick={ lanceImpression }></div>
                                <div class="cell_4">
                                    <b>GRAND LIVRE AUXILIAIRE</b>
                                </div>
                                <div class="cell_5"></div>
                                <div class="cell_6"></div>
                                <div class="cell_7"></div>
                            </div>
                            <div class="entete-tableau_1">
                                <div class="cell_1">
                                    <p>Journal</p>
                                    <p>Date</p>
                                </div>
                                <div class="cell_2">
                                    <p>Opération</p>
                                    <p>Pièce</p>
                                </div>
                                <div class="cell_3">Libelle</div>
                                <div class="cell_4"><!-- Tiers - Analytique --></div>
                                <div class="cell_5"><!-- L/R --></div>
                                <div class="cell_6">Débit</div>
                                <div class="cell_7">Crédit</div>
                                <div class="cell_8">Solde</div>
                            </div>
                            <!-- { console.log('grandlivre_auxiliaire : ' + JSON.stringify(grandlivre_auxiliaire)) && "."} -->
                            <div each={ grandlivre_auxiliaire } if={ ! comptesFournisseursSalariesMovChecked || ( debit != 0 || credit != 0) } class="table c100 fournisseurs">
                                <div if={ ! soldeZeroChecked || ( solde_debit != 0 || solde_credit != 0) } class="show_infos show_ba_sous_classe" onclick={ showBaComptes }>
                                    <div class="cell_1" >{ ref_sous_classe }  { libelle_sous_classe }</div>
                                    <div class="cell_2 total_ba_sous_classe">{ formatNumber(debit) }</div>
                                    <div class="cell_3">{ formatNumber(credit) }</div>
                                    <div class="cell_4">{ formatNumber(solde_sous_classe) }</div>
                                </div>
                                <div each={ bacomptes } if={ ! comptesFournisseursSalariesMovChecked || ( debit != 0 || credit != 0) } class="table c100 ba_comptes">
                                    <div if={ ! soldeZeroChecked || ( solde_debit != 0 || solde_credit != 0) } class="show_infos show_ba_comptes" onclick={ showBaFournisseursSalaries }>
                                        <div class="cell_1">{ ref_compte } { libelle_compte }</div>
                                        <div class="cell_2 total_ba_comptes">{ formatNumber(debit) }</div>
                                        <div class="cell_3">{ formatNumber(credit) }</div>
                                        <div class="cell_4">{ formatNumber(solde_compte) }</div>
                                    </div>
                                    <div each={ fournisseur_salarie } if={ ! comptesFournisseursSalariesMovChecked || ( debit != 0 || credit != 0) } class="table c100 ba_fournisseurs_salaries">
                                        <div if={ ! soldeZeroChecked || ( solde_debit != 0 || solde_credit != 0) } class="show_infos show_ba_fournisseurs_salaries" onclick={ showEcritures }>
                                            <div class="cell_1">{ nom_salarie_fournisseur }</div>
                                            <div class="cell_2">{ formatNumber(debit) }</div>
                                            <div class="cell_3">{ formatNumber(credit) }</div>
                                            <div class="cell_4">{ formatNumber(solde_fournisseurs_salaries) }</div>
                                        </div>
                                        <div each={ ecritures } if={ (debit != 0 || credit != 0) } class="table c100 ecritures">
                                            <div class="show_infos show_ecritures">
                                                <div class="cell_1"><p>{ this.journaux[ this.idJournaux[ id_journal ]].libelle }</p><p>{ formatDate(date_ecriture) }</p></div>
                                                <div class="cell_2"><p>{ operation }</p> <p>{ piece }</p></div>
                                                <div class="cell_3">{ libelle_ecriture }</div>
                                                <div class="cell_4"> { libelle_salarie } { libelle_fournisseur }</div>
                                                <div class="cell_5"></div>
                                                <div class="cell_6">{ formatNumber(debit) }</div>
                                                <div class="cell_7">{ formatNumber(credit) }</div>
                                                <div class="cell_8">{ formatNumber(solde_ecriture) }</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- FIN GRAND LIVRE AUXILIAIRE -->
                        <!-- COMPTE RESULTAT -->
                        <div id="OngletCompteResultat2" class="OngletCompteResultat hidden">
                            <div class="table table_OngletCompteResultat">
                                <div class="cell_1 button_retour" onclick={ retourPageImpression } value="2"></div>
                                <div class="cell_2 button_export"></div>
                                <div class="cell_3 button_imprimer" id="lance_impression" onclick={ lanceImpression }></div>
                                <div class="cell_34 hidden" style="width:0%"></div>
                                <div class="cell_4">
                                    <p>COMPTE DE RÉSULTAT</p>
                                    <div if={ CompteResultatOeuvresSocialesChecked } class="only_oeuvres_sociales">Oeuvres Sociales</div>
                                    <div if={ CompteResultatFonctionnementChecked } class="only_fonctionnement">Fonctionnement</div>
                                </div>
                                <div class="cell_5">
                                    Résultat 
                                </div>
                                <div class="cell_6">
                                    Débit <p class="solde_resultat">{ formatNumber(solde_resultat_debit) }</p>
                                </div>
                                <div class="cell_7">
                                    Crédit <p class="solde_resultat">{ formatNumber(solde_resultat_credit) }</p>
                                </div>
                            </div>
                            <div class="entete-tableau_4">
                                <div if={ IS_CE } class="cell_1">
                                    <label for="only_oeuvres_sociales_fonctionnement2"></label>
                                    <input type="radio" onclick={ ToutCompteResultat } value="2" id="only_oeuvres_sociales_fonctionnement2" name="only_oeuvres_sociales_fonctionnement2" checked="checked">Tous les analytiques
                                </div>
                                <div if={ IS_CE } class="cell_2">
                                    <input type="radio" onclick={ CompteResultatFonctionnement } value="2" name="only_oeuvres_sociales_fonctionnement2">Uniquement Fonctionnement
                                </div>
                                <div if={ IS_CE } class="cell_3">
                                    <input type="radio" onclick={ CompteResultatOeuvresSociales } value="2" name="only_oeuvres_sociales_fonctionnement2">Uniquement Oeuvres Sociales
                                </div>
                                <div class="cell_4"></div>
                            </div>
                            <div class="entete-tableau">
                                <div class="cell_1"></div>
                                <div class="cell_2">Nature</div>
                                <div class="cell_3">{ nom_exo }</div>
                                <div class="cell_4"></div>
                            </div>
                            <div class="table c100 compte_resultat">
                                <div each={ resultat } class="table c100 tab_chapitres" if={ ( ! CompteResultatFonctionnementChecked && ! CompteResultatOeuvresSocialesChecked && solde != 0 ) || ( CompteResultatFonctionnementChecked && solde_f != 0) || ( CompteResultatOeuvresSocialesChecked && solde_o != 0) }>
                                    <div class="show_infos show_chapitres" onclick={ showChapitres }>
                                        <div class="cell_1">{ libelle_chapitre }</div>
                                        <div class="cell_2"></div>
                                        <div if={ ( ! CompteResultatFonctionnementChecked && ! CompteResultatOeuvresSocialesChecked ) } class="cell_3">{ formatNumber(solde) }</div>
                                        <div if={ ( CompteResultatFonctionnementChecked ) } class="cell_3">{ formatNumber(solde_f) }</div>
                                        <div if={ ( CompteResultatOeuvresSocialesChecked ) } class="cell_3">{ formatNumber(solde_o) }</div>
                                        <div class="cell_4"></div>
                                    </div>
                                    <div each={ sous_chapitres } class="table c100 tab_sous_chapitres" if={ ( ! CompteResultatFonctionnementChecked && ! CompteResultatOeuvresSocialesChecked && solde != 0 ) || ( CompteResultatFonctionnementChecked && solde_f != 0) || ( CompteResultatOeuvresSocialesChecked && solde_o != 0) }> <!-- if={ sous_chapitres } -->
                                        <div class="show_infos show_sous_chapitres" onclick={ showSousChapitres } if={ id_sous_chapitre != 0 }> <!-- if={ id_sous_chapitre != 0 } -->
                                            <div class="cell_1">{ libelle_sous_chapitre }</div>
                                            <div class="cell_2"></div>
                                            <div if={ ( ! CompteResultatFonctionnementChecked && ! CompteResultatOeuvresSocialesChecked ) } class="cell_3">{ formatNumber(solde) }</div>
                                            <div if={ ( CompteResultatFonctionnementChecked ) } class="cell_3">{ formatNumber(solde_f) }</div>
                                            <div if={ ( CompteResultatOeuvresSocialesChecked ) } class="cell_3">{ formatNumber(solde_o) }</div>
                                            <div class="cell_4"></div>
                                        </div>
                                        <div each={ sous_sous_chapitres } class="table c100 tab_sous_sous_chapitres" if={ ( ! CompteResultatFonctionnementChecked && ! CompteResultatOeuvresSocialesChecked && solde != 0 ) || ( CompteResultatFonctionnementChecked && solde_f != 0) || ( CompteResultatOeuvresSocialesChecked && solde_o != 0) }>
                                            <div class="show_infos show_sous_sous_chapitres" id="show_sous_sous_chapitres" onclick={ showSousSousChapitres } if={ id_sous_sous_chapitre != 0 }> <!-- if={ id_sous_sous_chapitre != 0 } -->
                                                <div class="cell_1">{ libelle_sous_sous_chapitre }</div>
                                                <div class="cell_2"></div>
                                                <div if={ ( ! CompteResultatFonctionnementChecked && ! CompteResultatOeuvresSocialesChecked ) } class="cell_3">{ formatNumber(solde) }</div>
                                                <div if={ ( CompteResultatFonctionnementChecked ) } class="cell_3">{ formatNumber(solde_f) }</div>
                                                <div if={ ( CompteResultatOeuvresSocialesChecked ) } class="cell_3">{ formatNumber(solde_o) }</div>
                                                <div class="cell_4"></div>
                                            </div>
                                            <div each={ comptes } class="table c100 tab_comptes" nb_o={ nb_oeuvre } nb_f={ nb_fonctionnement }>
                                                <div class="show_infos show_comptes" onclick={ showChComptes } if={ ( ! CompteResultatFonctionnementChecked && ! CompteResultatOeuvresSocialesChecked ) || ( CompteResultatFonctionnementChecked && nb_fonctionnement != 0) || ( CompteResultatOeuvresSocialesChecked && nb_oeuvre != 0)}> <!-- if={ ( ! CompteResultatFonctionnementChecked && ! CompteResultatOeuvresSocialesChecked ) || ( CompteResultatFonctionnementChecked && nb_fonctionnement != 0) || ( CompteResultatOeuvresSocialesChecked && nb_oeuvre != 0)} -->
                                                    <div class="cell_1">{ ref_compte } { libelle_compte }</div>
                                                    <div class="cell_2"></div>
                                                    <div if={ ( ! CompteResultatFonctionnementChecked && ! CompteResultatOeuvresSocialesChecked ) } class="cell_3">{ formatNumber(solde) }</div>
                                                    <div if={ ( CompteResultatFonctionnementChecked && nb_fonctionnement != 0) } class="cell_3">{ formatNumber(solde_f) }</div>
                                                    <div if={ ( CompteResultatOeuvresSocialesChecked && nb_oeuvre != 0) } class="cell_3">{ formatNumber(solde_o) }</div>
                                                    <div class="cell_4"></div> 
                                                </div>
                                                <div each={ ecritures } class="table c100 tab_analytiques"> <!-- if={ ( ! CompteResultatFonctionnementChecked && ! CompteResultatOeuvresSocialesChecked ) || ( CompteResultatFonctionnementChecked && nature == 'fonctionnement') || ( CompteResultatOeuvresSocialesChecked && nature == 'oeuvres_sociales' ) } -->
                                                    <div class="show_infos show_analytique" if={ ( ! CompteResultatFonctionnementChecked && ! CompteResultatOeuvresSocialesChecked ) || ( CompteResultatFonctionnementChecked && nature == 'fonctionnement') || ( CompteResultatOeuvresSocialesChecked && nature == 'oeuvres_sociales' ) }>
                                                        <div class="cell_1">{ libelle_analytique }</div>
                                                        <div class="cell_2">{ nature }</div>
                                                        <div class="cell_3">{ formatNumber(solde) }</div>
                                                        <div class="cell_4"></div> 
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- <div each={ comptes } class="table c100 tab_comptes" nb_o={ nb_oeuvre } nb_f={ nb_fonctionnement }>
                                            <div class="show_infos show_comptes" onclick={ showChComptes } if={ ( ! CompteResultatFonctionnementChecked && ! CompteResultatOeuvresSocialesChecked ) || ( CompteResultatFonctionnementChecked && nb_fonctionnement != 0) || ( CompteResultatOeuvresSocialesChecked && nb_oeuvre != 0)}>
                                                <div class="cell_1">{ ref_compte } { libelle_compte }</div>
                                                <div class="cell_2"></div>
                                                <div if={ ( ! CompteResultatFonctionnementChecked && ! CompteResultatOeuvresSocialesChecked ) } class="cell_3">{ formatNumber(solde) }</div>
                                                <div if={ ( CompteResultatFonctionnementChecked && nb_oeuvre != 0) } class="cell_3">{ formatNumber(solde_f) }</div>
                                                <div if={ ( CompteResultatOeuvresSocialesChecked && nb_oeuvre != 0) } class="cell_3">{ formatNumber(solde_o) }</div>
                                                <div class="cell_4"></div> 
                                            </div>
                                            <div each={ ecritures } class="table c100 tab_analytiques">
                                                <div class="show_infos show_analytique" if={ ( ! CompteResultatFonctionnementChecked && ! CompteResultatOeuvresSocialesChecked ) || ( CompteResultatFonctionnementChecked && nature == 'fonctionnement') || ( CompteResultatOeuvresSocialesChecked && nature == 'oeuvres_sociales' ) }>
                                                    <div class="cell_1">{ libelle_analytique }</div>
                                                    <div class="cell_2">{ nature }</div>
                                                    <div class="cell_3">{ formatNumber(solde) }</div>
                                                    <div class="cell_4"></div> 
                                                </div>
                                            </div>
                                        </div> -->
                                    </div>
                                    <!-- <div each={ comptes } class="table c100 tab_comptes" nb_o={ nb_oeuvre } nb_f={ nb_fonctionnement }>
                                        <div class="show_infos show_comptes" onclick={ showChComptes } if={ ( ! CompteResultatFonctionnementChecked && ! CompteResultatOeuvresSocialesChecked ) || ( CompteResultatFonctionnementChecked && nb_fonctionnement != 0) || ( CompteResultatOeuvresSocialesChecked && nb_oeuvre != 0)}>
                                            <div class="cell_1">{ ref_compte } { libelle_compte }</div>
                                            <div class="cell_2"></div>
                                            <div if={ ( ! CompteResultatFonctionnementChecked && ! CompteResultatOeuvresSocialesChecked ) } class="cell_3">{ formatNumber(solde) }</div>
                                            <div if={ ( CompteResultatFonctionnementChecked && nb_oeuvre != 0) } class="cell_3">{ formatNumber(solde_f) }</div>
                                            <div if={ ( CompteResultatOeuvresSocialesChecked && nb_oeuvre != 0) } class="cell_3">{ formatNumber(solde_o) }</div>
                                            <div class="cell_4"></div> 
                                        </div>
                                        <div each={ ecritures } class="table c100 tab_analytiques">
                                            <div class="show_infos show_analytique" if={ ( ! CompteResultatFonctionnementChecked && ! CompteResultatOeuvresSocialesChecked ) || ( CompteResultatFonctionnementChecked && nature == 'fonctionnement') || ( CompteResultatOeuvresSocialesChecked && nature == 'oeuvres_sociales' ) }>
                                                <div class="cell_1">{ libelle_analytique }</div>
                                                <div class="cell_2">{ nature }</div>
                                                <div class="cell_3">{ formatNumber(solde) }</div>
                                                <div class="cell_4"></div> 
                                            </div>
                                        </div>
                                    </div> -->
                                </div>
                            </div>
                        </div>
                        <!-- FIN COMPTE RESULTAT -->
                    </div>
                </div>
            </div>
            <div if={ COMPTA_READ } class="nav_compta_impressions block-slider" id="nav_analytique">
                <header class="closed" onclick= { showContents }>
                    <a class="comptes-title center" onclick={ showComptaAnalytique }>
                        Comptabilité Analytique
                    </a>
                </header>
                <div class="slide-up hidden" id="show_compta_analytique hidden">
                    <div class="line-separator"></div>
                    <div class="compta_content">
                        <div class="compta_content">
                            <div class="impressions_comptanalytique">
                                <div class="table table_impressions_comptanalytique">
                                    <div class="row row_impressions_comptanalytique">
                                        <div class="cell cell_impressions_comptanalytique1">
                                            <input id="img_grand_livre_analytique" onclick={ Onglet_grandLivreAnalytique } id-for-uncheck="id_grand_livre_analytique" type="checkbox" value="grandlivreanalytique">
                                            <label for="img_grand_livre_analytique"></label>
                                        </div>
                                        <div class="cell cell_impressions_comptanalytique2">
                                            <input id="img_balance_analytique" onclick={ Onglet_balanceAnalytique } id-for-uncheck="id_balance_analytique" type="checkbox" value="balance_analytique">
                                            <label for="img_balance_analytique"></label>
                                        </div>
                                        <div class="cell cell_impressions_comptanalytique3">
                                            <input id="img_situation_budgetaire" onclick={ Onglet_situationBudgetaire } id-for-uncheck="id_situation_budgetaire" type="checkbox" value="situation_budgetaire">
                                            <label for="img_situation_budgetaire"></label>
                                        </div>
                                         <div class="cell cell_impressions_comptanalytique4">
                                            <input id="img_synthese_budgetaire" onclick={ Onglet_syntheseBudgetaire } id-for-uncheck="id_synthese_budgetaire" type="checkbox" value="synthese_budgetaire">
                                            <label for="img_synthese_budgetaire"></label>
                                        </div>
                                    </div>
                                </div>
                                <div class="nombreEcritures_analytique">
                                    Nombre d'écritures : { nbr_ecritures }
                                </div>
                            </div>
                            <!-- GRAND LIVRE ANALYTIQUE -->
                                <div id="ongletgrandlivreAnalytique2" class="ongletgrandlivreAnalytique hidden">
                                    <div class="table table_grandlivres_filtres_ongletgrandlivreAnalytique">
                                        <div class="cell_1 button_retour" onclick={ retourPageImpression2 } value="2"></div>
                                        <div class="cell_2 button_export"> </div>
                                        <div class="cell_3 button_imprimer" id="lance_impression" onclick={ lanceImpression }></div>
                                        <div class="cell_4">
                                            <b>GRAND LIVRE ANALYTIQUE</b>
                                            <div if={ OeuvresSocialesClikChecked } class="only_oeuvres_sociales">Oeuvres Sociales</div>
                                            <div if={ FonctionnementClikChecked } class="only_fonctionnement">Fonctionnement</div>
                                        </div>
                                        <div class="cell_5"></div>
                                        <div class="cell_6"></div>
                                        <div class="cell_7"></div>
                                    </div>
                                    <div class="entete-tableau_3">
                                        <div if={ IS_CE } class="cell_4">
                                            <input type="radio" onclick={ ToutAnalytique1 } value="2" name="oeuvres_sociales_fonctionnement2" checked="checked">Tous les analytiques
                                        </div>
                                        <div if={ IS_CE } class="cell_1">
                                            <input type="radio" onclick={ OnlyFonctionnement1 } value="2" name="oeuvres_sociales_fonctionnement2">Uniquement Fonctionnement  
                                        </div>
                                        <div if={ IS_CE } class="cell_2">
                                            <input type="radio" onclick={ OnlyOeuvres1 } value="2" name="oeuvres_sociales_fonctionnement2">Uniquement Oeuvres Sociales
                                        </div>
                                        <div if={ IS_CE } class="cell_3"></div> 
                                    </div>
                                    <div class="entete-tableau">
                                        <div class="cell_1">
                                            <p>Journal</p>
                                            <p>Date</p>
                                        </div>
                                        <div class="cell_2">
                                            <p>Opération</p>
                                            <p>Pièce</p>
                                        </div>
                                        <div class="cell_3">Libelle</div>
                                        <div class="cell_4"><p>N° Compte</p></div>
                                        <div class="cell_5 L_R">L/R</div>
                                        <div class="cell_6 reel_debit">Débit</div>
                                        <div class="cell_7 reel_credit">Crédit</div>
                                        <div class="cell_8">Solde</div>
                                    </div>
                                    <div each={ comptanalytique } if={ ( AnalytiqueMovChecked || ( credit_reel != 0) || ( debit_reel != 0)) && (( ! OeuvresSocialesClikChecked && ! FonctionnementClikChecked ) || ( OeuvresSocialesClikChecked && nb_oeuvre != 0) || ( FonctionnementClikChecked && nb_fonctionnement != 0)) } class="table c100 table_livreAnalytique hidden" test={ nb_oeuvre }>
                                        <div class="show_infos show_budgets" if={ ! FonctionnementClikChecked && ! OeuvresSocialesClikChecked || ( FonctionnementClikChecked && ( credit_reel_f != 0 || debit_reel_f != 0)) || ( OeuvresSocialesClikChecked && ( credit_reel_o != 0 || debit_reel_o != 0)) } onclick={ showAnalytiques }>
                                            <div class="cell_1">{ libelle_budget }</div>
                                            <div if={ ( ! OeuvresSocialesClikChecked && ! FonctionnementClikChecked ) } class="cell_4">{ formatNumber(debit_reel) }</div>
                                            <div if={ ( FonctionnementClikChecked && nb_fonctionnement != 0) } class="cell_4">{ formatNumber(debit_reel_f) }</div>
                                            <div if={ ( OeuvresSocialesClikChecked && nb_oeuvre != 0) } class="cell_4">{ formatNumber(debit_reel_o) }</div>
                                            <div if={ ( ! OeuvresSocialesClikChecked && ! FonctionnementClikChecked ) } class="cell_5">{ formatNumber(credit_reel) }</div>
                                            <div if={ ( FonctionnementClikChecked && nb_fonctionnement != 0) } class="cell_5">{ formatNumber(credit_reel_f) }</div>
                                            <div if={ ( OeuvresSocialesClikChecked && nb_oeuvre != 0) } class="cell_5">{ formatNumber(credit_reel_o) }</div>
                                            <div if={ ( ! OeuvresSocialesClikChecked && ! FonctionnementClikChecked ) } class="cell_6">{ formatNumber(solde) }</div>
                                            <div if={ ( FonctionnementClikChecked && nb_fonctionnement != 0) } class="cell_6">{ formatNumber(solde_f) }</div>
                                            <div if={ ( OeuvresSocialesClikChecked && nb_oeuvre != 0) } class="cell_6">{ formatNumber(solde_o) }</div>
                                        </div>
                                        <div each={ analytique } if={ ( AnalytiqueMovChecked || ( credit_reel != 0) || ( debit_reel != 0)) && (( ! OeuvresSocialesClikChecked && ! FonctionnementClikChecked ) || ( OeuvresSocialesClikChecked && nature == 'oeuvres_sociales') || ( FonctionnementClikChecked && nature == 'fonctionnement')) } class="table c100 analytiques hidden">
                                            <div class="show_infos show_analytiques" onclick={ showEcritures }>
                                                <div class="cell_1">{ libelle_analytique }</div>
                                                <div if={ IS_CE } class="cell_2">{ nature }</div>
                                                <div if={ IS_ASSO } class="cell_2"></div>
                                                <div class="cell_4">{ formatNumber(debit_reel) }</div>
                                                <div class="cell_5">{ formatNumber(credit_reel) }</div>
                                                <div class="cell_6">{ formatNumber(solde) }</div>
                                            </div>
                                            <div each={ ecritures } if={ (credit_reel != 0) || (debit_reel != 0) } class="table c100 ecritures hidden">
                                                <div class="show_infos show_ecritures">
                                                    <div class="cell_1"><p>{ this.journaux[ this.idJournaux[ id_journal ]].libelle }</p><p>{ formatDate(date_ecriture) }</p></div>
                                                    <div class="cell_2"><p>{ operation }</p> <p>{ piece }</p></div>
                                                    <div class="cell_3">{ libelle_ecriture }</div>
                                                    <div class="cell_4"> <p>{ ref_compte }</p></div>
                                                    <div class="cell_5"></div>
                                                    <div class="cell_6">{ formatNumber(debit_reel) }</div>
                                                    <div class="cell_7">{ formatNumber(credit_reel) }</div>
                                                    <div class="cell_8">{ formatNumber(solde) }</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <!-- FIN GRAND LIVRE ANALYTIQUE -->
                            <!-- BALANCE ANALYTIQUE -->
                            <div id="balanceanalytique2" class="balanceanalytique hidden">
                                <div class="table table_impressions_filtres_balanceanalytique">
                                    <div class="cell_1 button_retour" onclick={ retourPageImpression2 } value="2"></div>
                                    <div class="cell_2 button_export"></div>
                                    <div class="cell_3 button_imprimer" id="lance_impression" onclick={ lanceImpression }></div>
                                    <div class="cell_4">
                                        <b>BALANCE ANALYTIQUE</b>
                                        <div if={ OeuvresSocialesClikChecked2 } class="only_oeuvres_sociales">Oeuvres Sociales</div>
                                        <div if={ FonctionnementClikChecked2 } class="only_fonctionnement">Fonctionnement</div>
                                    </div>
                                    <div class="cell_5"></div>
                                    <div class="cell_6"></div>
                                    <div class="cell_7"></div>
                                </div>
                                <div class="entete-tableau_2">
                                    <div if={ IS_CE } class="cell_4">
                                        <input type="radio" onclick={ ToutAnalytique } value="2" name="only_oeuvres_sociales_fonctionnement2" checked="checked">Tous les analytiques
                                    </div>
                                    <div if={ IS_CE } class="cell_1">
                                        <input type="radio" onclick={ OnlyFonctionnement } value="2" name="only_oeuvres_sociales_fonctionnement2">Uniquement Fonctionnement
                                    </div>
                                    <div if={ IS_CE } class="cell_2">
                                        <input type="radio" onclick={ OnlyOeuvres } value="2" name="only_oeuvres_sociales_fonctionnement2">Uniquement Oeuvres Sociales
                                    </div>
                                    <div if={ IS_CE } class="cell_3">
                                    </div> 
                                </div>
                                <div class="entete-tableau_1">
                                    <div class="cell_1">
                                        <input onclick={ AnalytiqueMov } type="checkbox" name="comptes_mov">
                                        Uniquement analytiques mouvementés
                                    </div>
                                    <div class="cell_2"></div>
                                    <div class="cell_3">Cumuls</div>
                                    <div class="cell_4">Solde</div>
                                </div>
                                <div class="entete-tableau entete-tableau-balanceanalytique">
                                    <div class="cell_1 comptes_vide"></div>
                                    <div if={ IS_CE } class="cell_2 libelle_nature">Nature</div>
                                    <div if={ IS_ASSO } class="cell_2 libelle_vide"></div>
                                    <div class="cell_3">
                                        <div class="debit_credit">
                                            <div class="cell_debit">Débit</div>
                                            <div class="cell_credit">Crédit</div>
                                        </div>
                                    </div>
                                    <div class="cell_4">
                                        <div class="debit_credit">
                                            <div class="cell_debit">Débit</div>
                                            <div class="cell_credit">Crédit</div>
                                        </div>
                                    </div>
                                </div>
                                <div each={ comptanalytique } if={ (! AnalytiqueMovChecked || ( debit_reel != 0 || credit_reel != 0)) && (( ! OeuvresSocialesClikChecked2 && ! FonctionnementClikChecked2 ) || ( OeuvresSocialesClikChecked2 && nb_oeuvre != 0) || ( FonctionnementClikChecked2 && nb_fonctionnement != 0)) } class="table c100 table_livreAnalytique" nb_o={ nb_oeuvre } nb_f={ nb_fonctionnement }>
                                    <div class="show_infos show_budgets" if={ ( ! AnalytiqueMovChecked && FonctionnementClikChecked2 ) || ( AnalytiqueMovChecked && FonctionnementClikChecked2 && ( debit_reel_f != 0 || credit_reel_f != 0)) || ( ! AnalytiqueMovChecked && OeuvresSocialesClikChecked2 ) || ( AnalytiqueMovChecked && OeuvresSocialesClikChecked2 && ( debit_reel_o != 0 || credit_reel_o != 0)) || ( ! AnalytiqueMovChecked && ! FonctionnementClikChecked2 && ! OeuvresSocialesClikChecked2 ) || ( AnalytiqueMovChecked && ! FonctionnementClikChecked2 && ! OeuvresSocialesClikChecked2  && ( debit_reel != 0 || credit_reel != 0)) } onclick={ showAnalytiques }>
                                        <div class="cell_1">{ libelle_budget }</div>
                                        <div class="cell_2"></div>
                                        <div class="cell_3">
                                            <div class="debit_credit">
                                                <div if={ ( ! OeuvresSocialesClikChecked2 && ! FonctionnementClikChecked2 ) } class="cell_debit">{ formatNumber(debit_reel) }</div>
                                                <div if={ ( ! OeuvresSocialesClikChecked2 && ! FonctionnementClikChecked2 ) }  class="cell_credit">{ formatNumber(credit_reel) }</div>
                                                <div if={ ( FonctionnementClikChecked2 && nb_fonctionnement != 0) } class="cell_debit">{ formatNumber(debit_reel_f) }</div>
                                                <div if={ ( FonctionnementClikChecked2 && nb_fonctionnement != 0) } class="cell_credit">{ formatNumber(credit_reel_f) }</div>
                                                <div if={ ( OeuvresSocialesClikChecked2 && nb_oeuvre != 0) } class="cell_debit">{ formatNumber(debit_reel_o) }</div>
                                                <div if={ ( OeuvresSocialesClikChecked2 && nb_oeuvre != 0) } class="cell_credit">{ formatNumber(credit_reel_o) }</div>
                                            </div>
                                        </div>
                                        <div class="cell_4">
                                            <div class="debit_credit">
                                                <!-- <div class="cell_debit">{ formatNumber(solde_debit) }</div>
                                                <div class="cell_credit">{ formatNumber(solde_credit) }</div> -->
                                                <div if={ ( ! OeuvresSocialesClikChecked2 && ! FonctionnementClikChecked2 ) } class="cell_debit">{ formatNumber(solde_debit) }</div>
                                                <div if={ ( ! OeuvresSocialesClikChecked2 && ! FonctionnementClikChecked2 ) }  class="cell_credit">{ formatNumber(solde_credit) }</div>
                                                <div if={ ( FonctionnementClikChecked2 && nb_fonctionnement != 0) } class="cell_debit">{ formatNumber(solde_debit_f) }</div>
                                                <div if={ ( FonctionnementClikChecked2 && nb_fonctionnement != 0) } class="cell_credit">{ formatNumber(solde_credit_f) }</div>
                                                <div if={ ( OeuvresSocialesClikChecked2 && nb_oeuvre != 0) } class="cell_debit">{ formatNumber(solde_debit_o) }</div>
                                                <div if={ ( OeuvresSocialesClikChecked2 && nb_oeuvre != 0) } class="cell_credit">{ formatNumber(solde_credit_o) }</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div each={ analytique } if={ (! AnalytiqueMovChecked || ( debit_reel != 0 || credit_reel != 0)) && (( ! OeuvresSocialesClikChecked2 && ! FonctionnementClikChecked2 ) || ( OeuvresSocialesClikChecked2 && nature == 'oeuvres_sociales') || ( FonctionnementClikChecked2 && nature == 'fonctionnement') ) } class="table c100 analytiques">
                                        <div class="show_infos show_analytiques" onclick={ showEcritures }>
                                            <div class="cell_1">{ libelle_analytique }</div>
                                            <div if={ IS_CE } class="cell_2 libelle_nature">{ nature }</div>
                                            <div if={ IS_ASSO } class="cell_2"></div>
                                            <div class="cell_3">
                                                <div class="debit_credit">
                                                    <div class="cell_debit">{ formatNumber(debit_reel) }</div>
                                                    <div class="cell_credit">{ formatNumber(credit_reel) }</div>
                                                </div>
                                            </div>
                                            <div class="cell_4">
                                                <div class="debit_credit">
                                                    <div class="cell_debit">{ formatNumber(solde_debit) }</div>
                                                    <div class="cell_credit">{ formatNumber(solde_credit) }</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div each={ ecritures } if={ ( credit_reel != 0) || ( debit_reel != 0) } class="table c100 ecritures hidden">
                                            <div class="show_infos show_ecritures">
                                                <div class="cell_1">{ ref_compte }</div>
                                                <div class="cell_2">{ libelle_compte }</div>
                                                <div class="cell_3">
                                                    <div class="debit_credit">
                                                        <div class="cell_debit">{ formatNumber(debit_reel) }</div>
                                                        <div class="cell_credit">{ formatNumber(credit_reel) }</div>
                                                    </div>
                                                </div>
                                                <div class="cell_4">
                                                    <div class="debit_credit">
                                                        <div class="cell_debit">{ formatNumber(solde_debit) }</div>
                                                        <div class="cell_credit">{ formatNumber(solde_credit) }</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- FIN BALANCE ANALYTIQUE -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <script>
        var app = opts;
        this.app = opts;
        var _this = this;
        _this.comptesMovChecked = false;
        _this.GrandLivreComptesMovChecked = false;
        _this.soldeZeroChecked = false;
        _this.AnalytiqueMovChecked = false;
        _this.OeuvresSocialesClikChecked = false;
        _this.FonctionnementClikChecked = false;
        _this.OeuvresSocialesClikChecked2 = false;
        _this.FonctionnementClikChecked2 = false;
        _this.CompteResultatFonctionnementChecked = false;
        _this.CompteResultatOeuvresSocialesChecked = false;
        var permissions = app.session.permissions;
        var COMPTA_READ = this.COMPTA_READ = permissions.COMPTA_READ || false;
        this.IS_CE = permissions.IS_CE || false;
       // var IS_ASSO = false; //this.IS_ASSO = permissions.IS_ASSO || false;
        app.on('unmount-impressions', function(){
            app.off('unmount-impressions');
            _this.unmount();
        });

        _this.app.loadScript('/js/admin/elements-manager.js','elements-manager_js', function(){
            _this.E_M = new E_M();

//_this.E_M.backEndError({error: { code: 1}, tag: _this,});

            if( _this.loaded ){
            }
        });

        function loadDateTemplate() {
            var $date = $('#front_date_enregistrement');
            if($date) {
                $.datepicker.setDefaults( $.datepicker.regional[ "fr" ] );
                $date.datepicker({
                  showOn: "button",
                  buttonImage: "/img/activites_menu.png",
                  buttonImageOnly: true,
                  buttonText: "Select date",
                  dateFormat: 'dd/mm/yy'
                });
            }
        }

        function formatName(item) {
            console.log('function name: ' + arguments.callee.caller.name);
            return $.trim((item.prenom || '') + ' ' + (item.nom || ''));
        };


// IMPRESSIONS COMPTA GENERALE & COMPTA ANALYTIQUE

        /*Onglet_banlaceGenerale(e){
            var indexdiv = $(e.currentTarget).attr('value');
            $('#balancegenerale' + indexdiv).removeClass('hidden');
            $('.impressions_comptagenerale').addClass('hidden');
            $('.sous_classe').removeClass('hidden'); 
            $('.comptes').removeClass('hidden');
        }*/

        Onglet_banlaceGenerale(e) {
            var id = e.currentTarget.getAttribute("id-for-uncheck");
            var checked = e.currentTarget.checked;
            if (checked == true){
                $('#balancegenerale2').removeClass('hidden');
                $('.impressions_comptagenerale').addClass('hidden');
                $('.sous_classe').removeClass('hidden'); 
                $('.comptes').removeClass('hidden');
                $('#img_grand_livre').attr('checked', false);
                $('#img_grand_livre_auxiliaire').attr('checked', false);
                $('#img_balance_auxiliaire').attr('checked', false);
                $('#img_compte_resultat').attr('checked', false);
                //console.log("true");
            } else {
                //console.log("false");
            }
        }

        Onglet_banlaceAuxiliare(e) {
            var id = e.currentTarget.getAttribute("id-for-uncheck");
            var checked = e.currentTarget.checked;
            if (checked == true){
                $('#balanceauxiliaire2').removeClass('hidden');
                $('.impressions_comptagenerale').addClass('hidden');
                $('.ba_sous_classe').removeClass('hidden'); 
                $('.ba_comptes').removeClass('hidden');
                $('.ba_fournisseurs_salaries').removeClass('hidden');
                $('#img_grand_livre').attr('checked', false);
                $('#img_grand_livre_auxiliaire').attr('checked', false);
                $('#img_balance_generale').attr('checked', false);
                $('#img_compte_resultat').attr('checked', false);
            }
        }

        Onglet_grandLivre(e) {
            var id = e.currentTarget.getAttribute("id-for-uncheck");
            var checked = e.currentTarget.checked;
            if (checked == true){
                $('#ongletgrandlivre2').removeClass('hidden');
                $('.sous_classe').removeClass('hidden'); 
                $('.comptes').removeClass('hidden'); 
                $('.ecritures').removeClass('hidden'); 
                $('.impressions_comptagenerale').addClass('hidden');
                $('#img_balance_generale').attr('checked', false);
                $('#img_grand_livre_auxiliaire').attr('checked', false);
                $('#img_balance_auxiliaire').attr('checked', false);
                $('#img_compte_resultat').attr('checked', false);
            }
        }

        Onglet_grandLivreAuxiliaire(e) {
            var id = e.currentTarget.getAttribute("id-for-uncheck");
            var checked = e.currentTarget.checked;
            if (checked == true){
                $('#OngletGrandLivreAuxiliaire2').removeClass('hidden');
                $('.impressions_comptagenerale').addClass('hidden');
                $('.ba_sous_classe').removeClass('hidden'); 
                $('.ba_comptes').removeClass('hidden');
                $('.ba_fournisseurs_salaries').removeClass('hidden');
                $('#img_grand_livre').attr('checked', false);
                $('#img_balance_generale').attr('checked', false);
                $('#img_balance_auxiliaire').attr('checked', false);
                $('#img_compte_resultat').attr('checked', false);
            }
        }

        Onglet_compteResultat(e) {
            var id = e.currentTarget.getAttribute("id-for-uncheck");
            var checked = e.currentTarget.checked;
            if (checked == true){
                $('#OngletCompteResultat2').removeClass('hidden');
                $('.impressions_comptagenerale').addClass('hidden');
                $('#img_grand_livre').attr('checked', false);
                $('#img_grand_livre_auxiliaire').attr('checked', false);
                $('#img_balance_auxiliaire').attr('checked', false);
                $('#img_balance_generale').attr('checked', false);
            }
        }

        Onglet_grandLivreAnalytique(e) {
            var id = e.currentTarget.getAttribute("id-for-uncheck");
            var checked = e.currentTarget.checked;
            if (checked == true){
                $('#ongletgrandlivreAnalytique2').removeClass('hidden');
                $('.table_livreAnalytique').removeClass('hidden');
                $('.analytiques').removeClass('hidden');
                $('.ecritures').removeClass('hidden');
                $('.impressions_comptanalytique').addClass('hidden');
            }
        }

        Onglet_balanceAnalytique(e) {
            var id = e.currentTarget.getAttribute("id-for-uncheck");
            var checked = e.currentTarget.checked;
            if (checked == true){
                getComptanalytique({
                    balance_analytique: 1, 
                    callback: function(){
                        //var getParams = { balance_analytique : 1 };
                        $('#balanceanalytique2').removeClass('hidden');
                        $('.impressions_comptanalytique').addClass('hidden');
                        $('.ecritures').addClass('hidden');
                    }
                });
            }
        }

        retourPageImpression2(e) {
            var indexdiv = $(e.currentTarget).attr('value');
            $('#ongletgrandlivreAnalytique' + indexdiv).addClass('hidden');
            $('#balanceanalytique' + indexdiv).addClass('hidden');
            $('.impressions_comptanalytique').removeClass('hidden');
            $('#img_balance_analytique').attr('checked', false);
            $('#img_grand_livre_analytique').attr('checked', false);  
        }

        retourPageImpression(e) {
            var indexdiv = $(e.currentTarget).attr('value');
            $('#balancegenerale' + indexdiv).addClass('hidden');
            $('#balanceauxiliaire' + indexdiv).addClass('hidden');
            $('#ongletgrandlivre' + indexdiv).addClass('hidden');
            $('#OngletCompteResultat' + indexdiv).addClass('hidden');
            $('#OngletGrandLivreAuxiliaire' + indexdiv).addClass('hidden');
            $('.impressions_comptagenerale').removeClass('hidden');
            $('.sous_classe').addClass('hidden'); 
            $('.comptes').addClass('hidden');
            //document.getElementById("img_balance_generale").checked = false; 
            $('#img_balance_generale').attr('checked', false);
            $('#img_balance_auxiliaire').attr('checked', false);
            $('#img_grand_livre').attr('checked', false);
            $('#img_grand_livre_auxiliaire').attr('checked', false);
            $('#img_compte_resultat').attr('checked', false);   
        }

        showSousClasse(e) {
            var parent = $(e.currentTarget.parentNode); /* impressions */
            $(".sous_classe", parent).toggleClass('hidden'); /* affiche sous classe qui est dans impressions */
            //$('.total_hidden_classe', parent).toggleClass('hidden');
        }

        showComptes(e) {
            var parentCompte = $(e.currentTarget.parentNode);
            $(".comptes", parentCompte).toggleClass('hidden');   
        }

        showBaComptes(e) {
            var parentCompte = $(e.currentTarget.parentNode);
            $(".ba_comptes", parentCompte).toggleClass('hidden');   
        }

        showBaFournisseursSalaries(e) {
            var parentFS = $(e.currentTarget.parentNode);
            $(".ba_fournisseurs_salaries", parentFS).toggleClass('hidden');   
        }

        showEcritures(e){
            var parentEcritures = $(e.currentTarget.parentNode);
            $(".ecritures", parentEcritures).toggleClass('hidden')
        }

        comptesMov(e) {
            _this.comptesMovChecked = e.currentTarget.checked;
            _this.update();
        }

        GrandLivreComptesMov(e) {
            _this.GrandLivreComptesMovChecked = e.currentTarget.checked;
            _this.update();
        }

        soldeZero(e) {
            _this.soldeZeroChecked = e.currentTarget.checked;
            _this.update();
        }

        comptesFournisseursSalariesMov(e) {
            _this.comptesFournisseursSalariesMovChecked = e.currentTarget.checked;
            _this.update();
        }     

        showDetailsClasse(e) {
            var id = e.currentTarget.getAttribute('id-to-toggle') ;
            $( '#' + id ).toggleClass('hidden');
        }

        showChapitres(e) {
            var parentChapitres = $(e.currentTarget.parentNode);
            $(".tab_sous_chapitres", parentChapitres).toggleClass('hidden');   
        }

        showSousChapitres(e) {
            var parentSousChapitres = $(e.currentTarget.parentNode);
            $(".tab_sous_sous_chapitres", parentSousChapitres).toggleClass('hidden');
        }

        showSousSousChapitres(e) {
            var parentSousSousChapitres = $(e.currentTarget.parentNode);
            $(".tab_comptes", parentSousSousChapitres).toggleClass('hidden');   
        }

        showChComptes(e) {
            var parentChCompte = $(e.currentTarget.parentNode);
            $(".tab_analytiques", parentChCompte).toggleClass('hidden');   
        }

         showAnalytiques(e){
            var parentAnalytiques = $(e.currentTarget.parentNode);
            $(".analytiques", parentAnalytiques).toggleClass('hidden')
        }

        showEcritures(e){
            var parentEcritures = $(e.currentTarget.parentNode);
            $(".ecritures", parentEcritures).toggleClass('hidden')
        }

        AnalytiqueMov(e) {
            _this.AnalytiqueMovChecked = e.currentTarget.checked;
            _this.update();
        }

        OeuvresSocialesClik(e) {
            _this.FonctionnementClikChecked = false;
            _this.OeuvresSocialesClikChecked = e.currentTarget.checked;
            _this.update();
        }

        OeuvresSocialesClik2(e) {
            _this.FonctionnementClikChecked2 = false;
            _this.OeuvresSocialesClikChecked2 = e.currentTarget.checked;
            _this.update();
        }

        FonctionnementClik(e) {
            _this.OeuvresSocialesClikChecked = false;
            _this.FonctionnementClikChecked = e.currentTarget.checked;
            _this.update(); 
        }

        ToutClik(e) {
            _this.OeuvresSocialesClikChecked = true;
            _this.FonctionnementClikChecked = true;
            _this.ToutClikChecked = e.currentTarget.checked;
            _this.update(); 
        }

        FonctionnementClik2(e) {
            _this.OeuvresSocialesClikChecked2 = false;
            _this.FonctionnementClikChecked2 = e.currentTarget.checked;
            _this.update(); 
        }

        OnlyFonctionnement(e) {
            var indexdiv = $(e.currentTarget).attr('value');
            _this.OeuvresSocialesClikChecked2 = false;
            _this.FonctionnementClikChecked2 = e.currentTarget.checked;
            _this.update();  
        }

        OnlyOeuvres(e) {
            var indexdiv = $(e.currentTarget).attr('value');
            _this.FonctionnementClikChecked2 = false;
            _this.OeuvresSocialesClikChecked2 = e.currentTarget.checked;
            _this.update(); 
        }

        ToutAnalytique(e){
          var indexdiv = $(e.currentTarget).attr('value');
            _this.OeuvresSocialesClikChecked2 = false;
            _this.FonctionnementClikChecked2 = false;
            _this.ToutClikChecked2 = e.currentTarget.checked;
            _this.update();   
        }

        OnlyFonctionnement1(e) {
            var indexdiv = $(e.currentTarget).attr('value');
            _this.OeuvresSocialesClikChecked = false;
            _this.FonctionnementClikChecked = e.currentTarget.checked;
            _this.update();  
        }

        OnlyOeuvres1(e) {
            var indexdiv = $(e.currentTarget).attr('value');
            _this.FonctionnementClikChecked = false;
            _this.OeuvresSocialesClikChecked = e.currentTarget.checked;
            _this.update(); 
        }

        ToutAnalytique1(e){
          var indexdiv = $(e.currentTarget).attr('value');
            _this.OeuvresSocialesClikChecked = false;
            _this.FonctionnementClikChecked = false;
            _this.ToutClikChecked2 = e.currentTarget.checked;
            _this.update();   
        }

        showComptaGenerale(e){
            $('#show_compta_analytique').addClass('hidden');
            $('#show_compta_generale').removeClass('hidden');
        }
        
        showComptaAnalytique(e){
            $('#show_compta_analytique').removeClass('hidden');
            $('#show_compta_generale').addClass('hidden');
        }

        CompteResultatFonctionnement(e) {
            var indexdiv = $(e.currentTarget).attr('value');
            _this.CompteResultatOeuvresSocialesChecked = false;
            _this.CompteResultatFonctionnementChecked = e.currentTarget.checked;
            _this.update();  
        }

        CompteResultatOeuvresSociales(e) {
            var indexdiv = $(e.currentTarget).attr('value');
            _this.CompteResultatFonctionnementChecked = false;
            _this.CompteResultatOeuvresSocialesChecked = e.currentTarget.checked;
            _this.update(); 
        }

        ToutCompteResultat(e){
          var indexdiv = $(e.currentTarget).attr('value');
            _this.CompteResultatOeuvresSocialesChecked = false;
            _this.CompteResultatFonctionnementChecked = false;
            _this.update();   
        }

        editElement(e){
            if(_this.E_M){
            _this.E_M.editElement({event: e, tag: _this,
                    end: function(params){
                        var item = params.item;
                        var edit = params.edit;
                        if(item.type === 'tresorerie'){
                            $('.type_tresorerie', edit).show();
                            $('.id_compte option', edit).each(function(){
                                var t = this.text;
                                if(t.charAt(0)!=='5'){
                                    this.setAttribute('disabled', 'disabled');
                                }
                            });
                        }
                    }
                });
            }
        }

        this.formatNumber = function formatNumber(x) {
                                x = x.toFixed(2);
                                var parts = x.toString().split(".");
                                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, " ");
                                return parts.join(".");
                            }

        this.formatDate = function formatDate (date) {
                                var datePart = date.match(/\d+/g),
                                year = datePart[0],
                                month = datePart[1], 
                                day = datePart[2];
                                return day+'/'+month+'/'+year;
                            }

// BALANCE GENERALE
        _this.impressions = [];
        this.getFiltresElements = function getFiltresElements(){
            if ($('#img_balance_generale').is(':checked') == true) {
                getImpressions();
            }
            if ($('#img_grand_livre').is(':checked') == true) {
                getGrandlivre();
            }
            if ($('#img_balance_auxiliaire').is(':checked') == true) {
                getGrandlivreAuxiliaire();
            }
            if ($('#img_grand_livre_auxiliaire').is(':checked') == true) {
                getGrandlivreAuxiliaire();
            }
            if ($('#img_compte_resultat').is(':checked') == true) {
                getResultat();
            }
            if ($('#img_balance_analytique').is(':checked') == true) {
                getComptanalytique({balance_analytique: 1});
            }
             if ($('#img_grand_livre_analytique').is(':checked') == true) {
                getComptanalytique();
            }
        }
         function getImpressions(){
            //console.log('salut')
            var getParams = { };
            if( _this.selectedExercice ){
                getParams.id_exercice = _this.selectedExercice;
            }else if(document.getElementById('id_exercice')){
                getParams.id_exercice = document.getElementById('id_exercice').value;
            }

            // Filtres
            var filtre_data = [];
            for(var index in _this.filtres) {
                if(_this.filtres[index].ignore == false) {
                filtre_data.push(_this.filtres[index]);
                }
            }
            getParams.filtres = filtre_data;

            $.getJSON( '/admin/compta/impressions', getParams, function(data){
                //console.log(JSON.stringify(data));
                if(data && data.elements){
                    _this.impressions = [];
                    var newClasse = false;
                    var newSousClasse = false;
                    var currentClasseReference = undefined;
                    var currentSousClasseReference = undefined;
                    var classe_fields = { id_classe: 'id_classe', ref_classe: 'ref_classe', libelle_classe: 'libelle_classe' };
                    var sous_classe_fields = { id_sous_classe: 'id_sous_classe', ref_sous_classe: 'ref_sous_classe', libelle_sous_classe: 'libelle_sous_classe' };
                    var compte_fields = { id_compte: 'id_compte', ref_compte: 'ref_compte', libelle_compte: 'libelle_compte', nom_entreprise: 'nom_entreprise', nom_exercice: 'nom_exercice' };
                    var total_resultat_credit = 0;
                    var total_resultat_debit = 0;
                    for(var i = 0, l = data.elements.length; i < l; i++) {
                        //console.log("i : " + i);
                        if(data.elements[i].ref_classe != currentClasseReference) {
                            newClasse = true;
                            var objetClasse = new Object();
                            currentClasseReference = data.elements[i].ref_classe;
                            for(field in classe_fields){
                                objetClasse[classe_fields[field]] = data.elements[i][field];
                            }
                            objetClasse.credit = 0;
                            objetClasse.debit = 0;
                            objetClasse.solde_credit = 0;
                            objetClasse.solde_debit = 0;
                            objetClasse.sous_classe = [];
                        }else{
                            newClasse = false;
                        }

                        if(data.elements[i].ref_sous_classe != currentSousClasseReference) {
                            newSousClasse = true;
                            var objetSousClasse = new Object();
                            currentSousClasseReference = data.elements[i].ref_sous_classe;
                            for(field in sous_classe_fields){
                                objetSousClasse[sous_classe_fields[field]] = data.elements[i][field];
                            }
                            objetSousClasse.credit = 0;
                            objetSousClasse.debit = 0;
                            objetSousClasse.solde_credit = 0;
                            objetSousClasse.solde_debit = 0;
                            objetSousClasse.comptes = [];
                        }else{
                            newSousClasse = false;
                        }

                        var objetCompte = new Object();
                        for(field in compte_fields){
                            objetCompte[compte_fields[field]] = data.elements[i][field];
                            if (field == "nom_entreprise"){
                                $("#entrepriseName").text(data.elements[i][field]);
                            }
                            if (field == "nom_exercice"){
                                $("#exerciceName").text("Exercice : " + data.elements[i][field]);
                            }
                        }
                            objetCompte.credit = 0;
                            objetCompte.debit = 0;
                            objetCompte.solde_credit = 0;
                            objetCompte.solde_debit = 0;


                        if (data.elements[i].credit != null) {
                            objetCompte.credit = parseFloat(data.elements[i].credit);
                            objetSousClasse.credit += parseFloat(data.elements[i].credit);
                            objetClasse.credit += parseFloat(data.elements[i].credit);
                        }

                        if (data.elements[i].debit != null) {
                            objetCompte.debit = parseFloat(data.elements[i].debit);
                            objetSousClasse.debit += parseFloat(data.elements[i].debit);
                            objetClasse.debit += parseFloat(data.elements[i].debit);
                        }
                 
                        var solde = data.elements[i].debit - data.elements[i].credit;
                        if (solde >= 0){
                            objetCompte.solde_debit = solde;
                            objetCompte.solde_credit = 0;
                        } else {
                            objetCompte.solde_debit = 0;
                            objetCompte.solde_credit = Math.abs(solde);
                        }

                        var solde_sous_classe = objetSousClasse.debit - objetSousClasse.credit;
                        if (solde_sous_classe >= 0){
                            objetSousClasse.solde_debit = solde_sous_classe;
                            objetSousClasse.solde_credit = 0;
                        } else {
                            objetSousClasse.solde_debit = 0;
                            objetSousClasse.solde_credit = Math.abs(solde_sous_classe);
                        }

                        var solde_classe = objetClasse.debit - objetClasse.credit;
                        if (solde_classe >= 0){
                            objetClasse.solde_debit = solde_classe;
                            objetClasse.solde_credit = 0;
                        } else {
                            objetClasse.solde_debit = 0;
                            objetClasse.solde_credit = Math.abs(solde_classe);
                        }

                        if ((data.elements[i]).ref_classe == 6 || (data.elements[i]).ref_classe == 7) {
                            for (var y = 0; y < ((data.elements[i]).ref_classe).length; y++) {
                                var chiffre_credit = parseFloat(objetCompte.solde_credit);
                                total_resultat_credit = total_resultat_credit + chiffre_credit;
                            }
                            for (var y = 0; y < ((data.elements[i]).ref_classe).length; y++) {
                                var chiffre_debit = parseFloat(objetCompte.solde_debit);
                                total_resultat_debit = total_resultat_debit + chiffre_debit;
                            }
                        }

                        objetSousClasse.comptes.push(objetCompte);
                        if(newSousClasse){
                            objetClasse.sous_classe.push(objetSousClasse);
                        }
                        if(newClasse){
                            //console.log('resul : ' + objetClasse);
                            _this.impressions.push(objetClasse);
                        }
                    }
                        var solde_resultat_debit = 0;
                        var solde_resultat_credit = 0;
                        var solde_resultat = total_resultat_debit - total_resultat_credit;
                        if(solde_resultat >= 0) {
                           _this.solde_resultat_debit = solde_resultat;
                           _this.solde_resultat_credit = 0; 
                        } else {
                            _this.solde_resultat_credit = Math.abs(solde_resultat);
                            _this.solde_resultat_debit = 0; 
                        }
                    //  _this.numToLoad--;
                    _this.update();
                    //console.log('this.impressions: ' + JSON.stringify( _this.impressions));
                }else{
                    // TODO: no data elements, get and manage error!...
                }

                //_this.numToLoad--;
            })
        }
        getImpressions();
//// FIN BALANCE GENERALE

// GRAND LIVRE
        _this.grandlivre = [];

        function getGrandlivre(){
            var getParams = { };
            if( _this.selectedExercice ){
                getParams.id_exercice = _this.selectedExercice;
            }else if(document.getElementById('id_exercice')){
                getParams.id_exercice = document.getElementById('id_exercice').value;
            }

            var filtre_data = [];
            for(var index in _this.filtres) {
                if(_this.filtres[index].ignore == false) {
                filtre_data.push(_this.filtres[index]);
                }
            }
            getParams.filtres = filtre_data;

            $.getJSON( '/admin/compta/grandlivre', getParams, function(data){
                if(data && data.elements){
                    _this.grandlivre = [];
                    var newClasse = false;
                    var newSousClasse = false;
                    var newCompte = false;
                    var currentClasseReference = undefined;
                    var currentSousClasseReference = undefined;
                    var currentCompteReference = undefined;
                    var classe_fields = { id_classe: 'id_classe', ref_classe: 'ref_classe', libelle_classe: 'libelle_classe' };
                    var sous_classe_fields = { id_sous_classe: 'id_sous_classe', ref_sous_classe: 'ref_sous_classe', libelle_sous_classe: 'libelle_sous_classe' };
                    var compte_fields = { id_compte: 'id_compte', ref_compte: 'ref_compte', libelle_compte: 'libelle_compte' };
                    var ecriture_fields = { id_ecriture: 'id_ecriture', id_journal: 'id_journal', libelle_ecriture: 'libelle_ecriture', date_ecriture: 'date_ecriture', operation: 'operation', piece: 'piece', libelle_analytique: 'libelle_analytique', debit: 'debit', credit: 'credit', libelle_fournisseur: 'libelle_fournisseur', libelle_salarie: 'libelle_salarie'};
                    for(var i = 0, l = data.elements.length; i < l; i++) {
                        if(data.elements[i].ref_classe != currentClasseReference) {
                            newClasse = true;
                            var objetClasse = new Object();
                            currentClasseReference = data.elements[i].ref_classe;
                            for(field in classe_fields){
                                objetClasse[classe_fields[field]] = data.elements[i][field];
                            }
                            objetClasse.credit = 0;
                            objetClasse.debit = 0;
                            objetClasse.solde = 0;
                            objetClasse.sous_classe = [];
                        }else{
                            newClasse = false;
                        }

                        if(data.elements[i].ref_sous_classe != currentSousClasseReference) {
                            newSousClasse = true;
                            var objetSousClasse = new Object();
                            currentSousClasseReference = data.elements[i].ref_sous_classe;
                            for(field in sous_classe_fields){
                                objetSousClasse[sous_classe_fields[field]] = data.elements[i][field];
                            }
                            objetSousClasse.credit = 0;
                            objetSousClasse.debit = 0;
                            objetSousClasse.solde = 0;
                            objetSousClasse.comptes = [];
                        }else{
                            newSousClasse = false;
                        }

                        if(data.elements[i].ref_compte != currentCompteReference) {
                            newCompte = true;
                            var objetCompte = new Object();
                            currentCompteReference = data.elements[i].ref_compte;
                            for(field in compte_fields){
                                objetCompte[compte_fields[field]] = data.elements[i][field];
                            }
                            objetCompte.credit = 0;
                            objetCompte.debit = 0;
                            objetCompte.solde = 0;
                            objetCompte.ecritures = [];
                        }else{
                            newCompte = false;
                        }

                        var objetEcriture = new Object();
                        for(field in ecriture_fields){
                            objetEcriture[ecriture_fields[field]] = data.elements[i][field];
                        }
                            objetEcriture.credit = 0;
                            objetEcriture.debit = 0;
                            objetEcriture.solde = 0;
                 

                        if (data.elements[i].credit != null) {
                            objetEcriture.credit = parseFloat(data.elements[i].credit);
                            objetCompte.credit += parseFloat(data.elements[i].credit);
                            objetSousClasse.credit += parseFloat(data.elements[i].credit);
                            objetClasse.credit += parseFloat(data.elements[i].credit);
                        }

                        if (data.elements[i].debit != null) {
                            objetEcriture.debit = parseFloat(data.elements[i].credit);
                            objetCompte.debit += parseFloat(data.elements[i].debit);
                            objetSousClasse.debit += parseFloat(data.elements[i].debit);
                            objetClasse.debit += parseFloat(data.elements[i].debit);
                        }
                 

                        var solde = data.elements[i].debit - data.elements[i].credit;
                        if(solde >= 0) {
                            objetEcriture.debit = solde;
                            objetEcriture.credit = 0;
                        } else {
                           objetEcriture.credit = Math.abs(solde);
                            objetEcriture.debit = 0; 
                        }

                        var solde_ecriture = objetEcriture.debit - objetEcriture.credit;
                        objetEcriture.solde = solde_ecriture;

                        var solde_compte = objetCompte.debit - objetCompte.credit;
                        objetCompte.solde = solde_compte;

                        var solde_sous_classe = objetSousClasse.debit - objetSousClasse.credit;
                        objetSousClasse.solde = solde_sous_classe;

                        var solde_classe = objetClasse.debit - objetClasse.credit;
                        objetClasse.solde = solde_classe;

                        objetCompte.ecritures.push(objetEcriture);
                        if(newCompte){
                            objetSousClasse.comptes.push(objetCompte);
                        }
                        if(newSousClasse){
                            objetClasse.sous_classe.push(objetSousClasse);
                        }
                        if(newClasse){
                            _this.grandlivre.push(objetClasse);
                        }
                    }
                    //  _this.numToLoad--;
                    _this.update();
                }else{
                    // TODO: no data elements, get and manage error!...
                }
                //_this.numToLoad--;
            })
        }
        getGrandlivre();
//// FIN GRAND LIVRE

// BALANCE AUXILIAIRE & GRAND LIVRE AUXILIAIRE
        _this.grandlivre_auxiliaire = [];

         function getGrandlivreAuxiliaire(){
            var getParams = { };
            if( _this.selectedExercice ){
                getParams.id_exercice = _this.selectedExercice;
            }else if(document.getElementById('id_exercice')){
                getParams.id_exercice = document.getElementById('id_exercice').value;
            }

            var filtre_data = [];
            for(var index in _this.filtres) {
                if(_this.filtres[index].ignore == false) {
                filtre_data.push(_this.filtres[index]);
                }
            }
            getParams.filtres = filtre_data;

            $.getJSON( '/admin/compta/grandlivre_auxiliaire', getParams, function(data){
                //console.log('data : ', JSON.stringify(data));
                if(data && data.elements){
                    //console.log("i : " + data.elements.length);
                    _this.grandlivre_auxiliaire = [];
                    var newSousClasse = false;
                    var newCompte = false;
                    var newFournisseursSalaries = false;
                    var currentSousClasseReference = undefined;
                    var currentCompteReference = undefined;
                    var currentFournisseursSalariesReference = undefined;
                    var sous_classe_fields = { id_sous_classe: 'id_sous_classe', ref_sous_classe: 'ref_sous_classe', libelle_sous_classe: 'libelle_sous_classe' };
                    var compte_fields = { id_compte: 'id_compte', ref_compte: 'ref_compte', libelle_compte: 'libelle_compte' };
                    var fournisseurs_salaries_fields = { id_salarie_fournisseur: 'id_salarie_fournisseur', nom_salarie_fournisseur: 'nom_salarie_fournisseur', type: 'type'};
                    var ecriture_fields = { id_ecriture: 'id_ecriture', id_journal: 'id_journal', libelle_ecriture: 'libelle_ecriture', date_ecriture: 'date_ecriture', operation: 'operation', piece: 'piece', libelle_analytique: 'libelle_analytique', debit: 'debit', credit: 'credit', libelle_fournisseur: 'libelle_fournisseur', libelle_salarie: 'libelle_salarie'};
                    for(var i = 0, l = data.elements.length; i < l; i++) {
                        //console.log("i : " + data.elements.length);
                        if(data.elements[i].ref_sous_classe != currentSousClasseReference) {
                            newSousClasse = true;
                            var objetSousClasse = new Object();
                            currentSousClasseReference = data.elements[i].ref_sous_classe;
                            for(field in sous_classe_fields){
                                objetSousClasse[sous_classe_fields[field]] = data.elements[i][field];
                            }
                            objetSousClasse.credit = 0;
                            objetSousClasse.debit = 0;
                            objetSousClasse.bacomptes = [];
                        }else{
                            newSousClasse = false;
                        }
                        if(data.elements[i].ref_compte != currentCompteReference) {
                            newCompte = true;
                            var objetCompte = new Object();
                            currentCompteReference = data.elements[i].ref_compte;
                            for(field in compte_fields){
                                objetCompte[compte_fields[field]] = data.elements[i][field];
                            }
                            objetCompte.credit = 0;
                            objetCompte.debit = 0;
                            objetCompte.fournisseur_salarie = [];
                        }else{
                            newCompte = false;
                        }

                        if(data.elements[i].id_salarie_fournisseur != currentFournisseursSalariesReference) {
                            newFournisseursSalaries = true;
                            var objetFournisseursSalaries = new Object();
                            currentFournisseursSalariesReference = data.elements[i].id_salarie_fournisseur;
                            for(field in fournisseurs_salaries_fields){
                                objetFournisseursSalaries[fournisseurs_salaries_fields[field]] = data.elements[i][field];
                            }
                            objetFournisseursSalaries.credit = 0;
                            objetFournisseursSalaries.debit = 0;
                            objetFournisseursSalaries.ecritures = [];
                        } else {
                            newFournisseursSalaries = false;
                        }

                        var objetEcriture = new Object();
                        for(field in ecriture_fields){
                            objetEcriture[ecriture_fields[field]] = data.elements[i][field];
                        }
                            objetEcriture.credit = 0;
                            objetEcriture.debit = 0;

                        if (data.elements[i].credit != null) {
                            objetEcriture.credit = parseFloat(data.elements[i].credit);
                            objetFournisseursSalaries.credit += parseFloat(data.elements[i].credit);
                            objetCompte.credit += parseFloat(data.elements[i].credit);
                            objetSousClasse.credit += parseFloat(data.elements[i].credit);
                        }

                        if (data.elements[i].debit != null) {
                            objetEcriture.debit = parseFloat(data.elements[i].debit);
                            objetFournisseursSalaries.debit += parseFloat(data.elements[i].debit);
                            objetCompte.debit += parseFloat(data.elements[i].debit);
                            objetSousClasse.debit += parseFloat(data.elements[i].debit);
                        }

                        var solde_ecriture = objetEcriture.debit - objetEcriture.credit;
                        objetEcriture.solde_ecriture = solde_ecriture;

                        var solde_fournisseurs_salaries = objetFournisseursSalaries.debit - objetFournisseursSalaries.credit;
                        objetFournisseursSalaries.solde_fournisseurs_salaries = solde_fournisseurs_salaries;

                        var solde_compte = objetCompte.debit - objetCompte.credit;
                        objetCompte.solde_compte = solde_compte;

                        var solde_sous_classe = objetSousClasse.debit - objetSousClasse.credit;
                        objetSousClasse.solde_sous_classe = solde_sous_classe;

                        var solde_balance_ecriture = data.elements[i].debit - data.elements[i].credit;
                        if (solde_balance_ecriture >= 0){
                            objetEcriture.solde_debit = solde_balance_ecriture;
                            objetEcriture.solde_credit = 0;
                        } else {
                            objetEcriture.solde_debit = 0;
                            objetEcriture.solde_credit = Math.abs(solde_balance_ecriture);
                        }

                        var solde_balance_fournisseurs_salaries = data.elements[i].debit - data.elements[i].credit;
                        if (solde_balance_fournisseurs_salaries >= 0){
                            objetFournisseursSalaries.solde_debit = solde_balance_fournisseurs_salaries;
                            objetFournisseursSalaries.solde_credit = 0;
                        } else {
                            objetFournisseursSalaries.solde_debit = 0;
                            objetFournisseursSalaries.solde_credit = Math.abs(solde_balance_fournisseurs_salaries);
                        }

                        var solde_balance_compte = objetCompte.debit - objetCompte.credit;
                        if (solde_balance_compte >= 0){
                            objetCompte.solde_debit = solde_balance_compte;
                            objetCompte.solde_credit = 0;
                        } else {
                            objetCompte.solde_debit = 0;
                            objetCompte.solde_credit = Math.abs(solde_balance_compte);
                        }

                        var solde_balance_sous_classe = objetSousClasse.debit - objetSousClasse.credit;
                        if (solde_balance_sous_classe >= 0){
                            objetSousClasse.solde_debit = solde_balance_sous_classe;
                            objetSousClasse.solde_credit = 0;
                        } else {
                            objetSousClasse.solde_debit = 0;
                            objetSousClasse.solde_credit = Math.abs(solde_balance_sous_classe);
                        }

                        objetFournisseursSalaries.ecritures.push(objetEcriture);
                        if(newFournisseursSalaries){
                            objetCompte.fournisseur_salarie.push(objetFournisseursSalaries);
                        }
                        if(newCompte){
                            objetSousClasse.bacomptes.push(objetCompte);
                        }
                        if(newSousClasse){
                            _this.grandlivre_auxiliaire.push(objetSousClasse);
                        }
                    }
                    //_this.numToLoad--;
                    _this.update();
                }else{
                    // TODO: no data elements, get and manage error!...
                }
                //_this.numToLoad--;
            })
        }
        getGrandlivreAuxiliaire();
//// FIN BALANCE AUXILIAIRE & GRAND LIVRE AUXILIAIRE

// COMPTE RESULTAT
        _this.resultat = [];

        function getResultat(){
            var getParams = { };
            if( _this.selectedExercice ){
                getParams.id_exercice = _this.selectedExercice;
            }else if(document.getElementById('id_exercice')){
                getParams.id_exercice = document.getElementById('id_exercice').value;
            }

            $.getJSON( '/admin/compta/compte_resultat', getParams, function(data){
                if(data && data.elements){
                    _this.resultat = [];
                    var newChapitre = false;
                    var newSousChapitre = false;
                    var newSousSousChapitre = false;
                    var newCompte = false;
                    var currentChapitreId = undefined;
                    var currentSousChapitreId = undefined;
                    var currentSousSousChapitreId = undefined;
                    var currentCompteRef = undefined;
                    var chapitre_fields = { id_chapitre: 'id_chapitre', id_parent_chapitre: 'id_parent_chapitre', libelle_chapitre: 'libelle_chapitre' };
                    var sous_chapitre_fields = { id_sous_chapitre: 'id_sous_chapitre', id_parent_sous_chapitre: 'id_parent_sous_chapitre', libelle_sous_chapitre: 'libelle_sous_chapitre' };
                    var sous_sous_chapitre_fields = { id_sous_sous_chapitre: 'id_sous_sous_chapitre', id_parent_sous_sous_chapitre: 'id_parent_sous_sous_chapitre', libelle_sous_sous_chapitre: 'libelle_sous_sous_chapitre' };
                    var compte_fields = { id_compte: 'id_compte', ref_compte: 'ref_compte', libelle_compte: 'libelle_compte' };
                    var ecriture_fields = { id_ecriture: 'id_ecriture', id_journal: 'id_journal', libelle_ecriture: 'libelle_ecriture', date_ecriture: 'date_ecriture', operation: 'operation', piece: 'piece', libelle_analytique: 'libelle_analytique', nature: 'nature', debit: 'debit', credit: 'credit', libelle_fournisseur: 'libelle_fournisseur', libelle_salarie: 'libelle_salarie' };
                    for(var i = 0, l = data.elements.length; i < l; i++) {
                        if(data.elements[i].id_chapitre != currentChapitreId) {
                            newChapitre = true;
                            var objetChapitre = new Object();
                            currentChapitreId = data.elements[i].id_chapitre;
                            for(field in chapitre_fields){
                                objetChapitre[chapitre_fields[field]] = data.elements[i][field];
                            }
                            objetChapitre.nb_oeuvre = 0;
                            objetChapitre.nb_fonctionnement = 0;
                            objetChapitre.credit = 0;
                            objetChapitre.debit = 0;
                            objetChapitre.solde = 0;
                            objetChapitre.credit_o = 0;
                            objetChapitre.debit_o = 0;
                            objetChapitre.solde_o = 0;
                            objetChapitre.credit_f = 0;
                            objetChapitre.debit_f = 0;
                            objetChapitre.solde_f = 0;
                            objetChapitre.sous_chapitres = [];
                        } else {
                            newChapitre = false;
                        }

                        if(data.elements[i].id_sous_chapitre != currentSousChapitreId) {
                            newSousChapitre = true;
                            var objetSousChapitre = new Object();
                            currentSousChapitreId = data.elements[i].id_sous_chapitre;
                            for(field in sous_chapitre_fields){
                                objetSousChapitre[sous_chapitre_fields[field]] = data.elements[i][field];
                            }
                            objetSousChapitre.nb_oeuvre = 0;
                            objetSousChapitre.nb_fonctionnement = 0;
                            objetSousChapitre.credit = 0;
                            objetSousChapitre.debit = 0;
                            objetSousChapitre.solde = 0;
                            objetSousChapitre.credit_o = 0;
                            objetSousChapitre.debit_o = 0;
                            objetSousChapitre.solde_o = 0;
                            objetSousChapitre.credit_f = 0;
                            objetSousChapitre.debit_f = 0;
                            objetSousChapitre.solde_f = 0;
                            objetSousChapitre.sous_sous_chapitres = [];
                        }else{
                            newSousChapitre = false;
                            /*newChapitre = true;
                            var objetChapitre = new Object();
                            currentChapitreId = data.elements[i].id_chapitre;
                            for(field in chapitre_fields){
                                objetChapitre[chapitre_fields[field]] = data.elements[i][field];
                            }
                            objetChapitre.nb_oeuvre = 0;
                            objetChapitre.nb_fonctionnement = 0;
                            objetChapitre.credit = 0;
                            objetChapitre.debit = 0;
                            objetChapitre.solde = 0;
                            objetChapitre.credit_o = 0;
                            objetChapitre.debit_o = 0;
                            objetChapitre.solde_o = 0;
                            objetChapitre.credit_f = 0;
                            objetChapitre.debit_f = 0;
                            objetChapitre.solde_f = 0;
                            objetChapitre.comptes = [];*/
                        }

                        if(data.elements[i].id_sous_sous_chapitre != currentSousSousChapitreId) {
                            newSousSousChapitre = true;
                            var objetSousSousChapitre = new Object();
                            currentSousSousChapitreId = data.elements[i].id_sous_sous_chapitre;
                            for(field in sous_sous_chapitre_fields){
                                objetSousSousChapitre[sous_sous_chapitre_fields[field]] = data.elements[i][field];
                            }
                            objetSousSousChapitre.nb_oeuvre = 0;
                            objetSousSousChapitre.nb_fonctionnement = 0;
                            objetSousSousChapitre.credit = 0;
                            objetSousSousChapitre.debit = 0;
                            objetSousSousChapitre.solde = 0;
                            objetSousSousChapitre.credit_o = 0;
                            objetSousSousChapitre.debit_o = 0;
                            objetSousSousChapitre.solde_o = 0;
                            objetSousSousChapitre.credit_f = 0;
                            objetSousSousChapitre.debit_f = 0;
                            objetSousSousChapitre.solde_f = 0;
                            objetSousSousChapitre.comptes = [];
                        }else{
                            newSousSousChapitre = false;
                            /*newSousChapitre = true;
                            var objetSousChapitre = new Object();
                            currentSousChapitreId = data.elements[i].id_sous_chapitre;
                            for(field in sous_chapitre_fields){
                                objetSousChapitre[sous_chapitre_fields[field]] = data.elements[i][field];
                            }
                            objetSousChapitre.nb_oeuvre = 0;
                            objetSousChapitre.nb_fonctionnement = 0;
                            objetSousChapitre.credit = 0;
                            objetSousChapitre.debit = 0;
                            objetSousChapitre.solde = 0;
                            objetSousChapitre.credit_o = 0;
                            objetSousChapitre.debit_o = 0;
                            objetSousChapitre.solde_o = 0;
                            objetSousChapitre.credit_f = 0;
                            objetSousChapitre.debit_f = 0;
                            objetSousChapitre.solde_f = 0;
                            objetSousChapitre.comptes = [];*/
                        }

                        if(data.elements[i].ref_compte != currentCompteRef) {
                            newCompte = true;
                            var objetCompte = new Object();
                            currentCompteRef = data.elements[i].ref_compte;
                            for(field in compte_fields){
                                objetCompte[compte_fields[field]] = data.elements[i][field];
                            }
                            objetCompte.nb_oeuvre = 0;
                            objetCompte.nb_fonctionnement = 0;
                            objetCompte.credit = 0;
                            objetCompte.debit = 0;
                            objetCompte.solde = 0;
                            objetCompte.credit_o = 0;
                            objetCompte.debit_o = 0;
                            objetCompte.solde_o = 0;
                            objetCompte.credit_f = 0;
                            objetCompte.debit_f = 0;
                            objetCompte.solde_f = 0;
                            objetCompte.ecritures = [];
                        }else{
                            newCompte = false;
                        }

                        //console.log("res : " + JSON.stringify(data.elements[i]));

                        var objetEcriture = new Object();
                        for(field in ecriture_fields){
                            objetEcriture[ecriture_fields[field]] = data.elements[i][field];
                        }
                            objetEcriture.credit = 0;
                            objetEcriture.debit = 0;
                            objetEcriture.solde = 0;

                        if (objetEcriture.nature == 'oeuvres_sociales') {
                            objetCompte.nb_oeuvre++;
                        } else if (objetEcriture.nature == 'fonctionnement') {
                            objetCompte.nb_fonctionnement++;
                        }

                        /*if (objetChapitre.id_chapitre == null) {
                            objetChapitre.id_chapitre = 0;
                        }*/
                        if (objetSousChapitre.id_sous_chapitre == null) {
                            objetSousChapitre.id_sous_chapitre = 0;
                        }
                        if (objetSousSousChapitre.id_sous_sous_chapitre == null) {
                            objetSousSousChapitre.id_sous_sous_chapitre = 0;
                        }

                        if (data.elements[i].credit != null) {
                            objetEcriture.credit = parseFloat(data.elements[i].credit);
                            if (objetEcriture.nature == 'oeuvres_sociales'){
                                objetCompte.credit_o += parseFloat(data.elements[i].credit); 
                                objetSousSousChapitre.credit_o += parseFloat(data.elements[i].credit); 
                                objetSousChapitre.credit_o += parseFloat(data.elements[i].credit); 
                                objetChapitre.credit_o += parseFloat(data.elements[i].credit);  
                            } else if (objetEcriture.nature == 'fonctionnement'){
                                objetCompte.credit_f += parseFloat(data.elements[i].credit);
                                objetSousSousChapitre.credit_f += parseFloat(data.elements[i].credit);
                                objetSousChapitre.credit_f += parseFloat(data.elements[i].credit);
                                objetChapitre.credit_f += parseFloat(data.elements[i].credit);
                            }
                            objetCompte.credit += parseFloat(data.elements[i].credit);
                            //objetCompte.credit += parseFloat(data.elements[i].credit);
                            objetSousSousChapitre.credit += parseFloat(data.elements[i].credit);
                            objetSousChapitre.credit += parseFloat(data.elements[i].credit);
                            objetChapitre.credit += parseFloat(data.elements[i].credit);
                        }

                        if (data.elements[i].debit != null) {
                            objetEcriture.debit = parseFloat(data.elements[i].credit);
                            if (objetEcriture.nature == 'oeuvres_sociales'){
                                objetCompte.debit_o += parseFloat(data.elements[i].debit);
                                objetSousSousChapitre.debit_o += parseFloat(data.elements[i].debit);
                                objetSousChapitre.debit_o += parseFloat(data.elements[i].debit);
                                objetChapitre.debit_o += parseFloat(data.elements[i].debit);  
                            } else if (objetEcriture.nature == 'fonctionnement'){
                                objetCompte.debit_f += parseFloat(data.elements[i].debit);
                                objetSousSousChapitre.debit_f += parseFloat(data.elements[i].debit);
                                objetSousChapitre.debit_f += parseFloat(data.elements[i].debit);
                                objetChapitre.debit_f += parseFloat(data.elements[i].debit);
                            }
                            objetCompte.debit += parseFloat(data.elements[i].debit);
                            //objetCompte.debit += parseFloat(data.elements[i].debit);
                            objetSousSousChapitre.debit += parseFloat(data.elements[i].debit);
                            objetSousChapitre.debit += parseFloat(data.elements[i].debit);
                            objetChapitre.debit += parseFloat(data.elements[i].debit);
                        }

                        var solde = data.elements[i].debit - data.elements[i].credit;
                        if(solde >= 0) {
                            objetEcriture.debit = solde;
                            objetEcriture.credit = 0;
                        } else {
                            objetEcriture.credit = Math.abs(solde);
                            objetEcriture.debit = 0; 
                        }

                        var solde_ecriture = objetEcriture.debit - objetEcriture.credit;
                        objetEcriture.solde = solde_ecriture;

                        if (objetEcriture.nature == 'oeuvres_sociales'){
                            var solde_compte_o = objetCompte.debit_o - objetCompte.credit_o;
                            objetCompte.solde_o = solde_compte_o;
                            var solde_sous_sous_chapitre_o = objetSousSousChapitre.debit_o - objetSousSousChapitre.credit_o;
                            objetSousSousChapitre.solde_o = solde_sous_sous_chapitre_o;
                            var solde_sous_chapitre_o = objetSousChapitre.debit_o - objetSousChapitre.credit_o;
                            objetSousChapitre.solde_o = solde_sous_chapitre_o; 
                            var solde_chapitre_o = objetChapitre.debit_o - objetChapitre.credit_o;
                            objetChapitre.solde_o = solde_chapitre_o;  
                        } else if (objetEcriture.nature == 'fonctionnement'){
                            var solde_compte_f = objetCompte.debit_f - objetCompte.credit_f;
                            objetCompte.solde_f = solde_compte_f;
                            var solde_sous_sous_chapitre_f = objetSousSousChapitre.debit_f - objetSousSousChapitre.credit_f;
                            objetSousSousChapitre.solde_f = solde_sous_sous_chapitre_f;
                            var solde_sous_chapitre_f = objetSousChapitre.debit_f - objetSousChapitre.credit_f;
                            objetSousChapitre.solde_f = solde_sous_chapitre_f; 
                            var solde_chapitre_f = objetChapitre.debit_f - objetChapitre.credit_f;
                            objetChapitre.solde_f = solde_chapitre_f;
                        }
                        var solde_compte = objetCompte.debit - objetCompte.credit;
                        objetCompte.solde = solde_compte;
                        var solde_sous_sous_chapitre = objetSousSousChapitre.debit - objetSousSousChapitre.credit;
                        objetSousSousChapitre.solde = solde_sous_sous_chapitre;
                        var solde_sous_chapitre = objetSousChapitre.debit - objetSousChapitre.credit;
                        objetSousChapitre.solde = solde_sous_chapitre;
                        var solde_chapitre = objetChapitre.debit - objetChapitre.credit;
                        objetChapitre.solde = solde_chapitre;
                        objetCompte.ecritures.push(objetEcriture);
                        if(newCompte){
                            //if(objetSousSousChapitre){
                               objetSousSousChapitre.comptes.push(objetCompte); 
                            //} else {
                                //ojetSousChapitre.comptes.push(objetCompte);
                            //}   
                        }
                        if(newSousSousChapitre){
                            objetSousChapitre.sous_sous_chapitres.push(objetSousSousChapitre);
                        }
                        if(newSousChapitre){
                            //if(objetSousChapitre){
                                objetChapitre.sous_chapitres.push(objetSousChapitre);
                            //} else {
                                //objetChapitre.comptes.push(objetCompte);
                            //}
                        }
                        if(newChapitre){
                            _this.resultat.push(objetChapitre);
                        }
                    }

                    //  _this.numToLoad--;
                    _this.update();
                }else{
                    // TODO: no data elements, get and manage error!...
                }
                //_this.numToLoad--;
            })
        }
        getResultat();
//// FIN COMPTE RESULTAT

// BALANCE ANALYTIQUE & GRAND LIVRE ANALYTIQUE
        _this.comptanalytique = [];

        function getComptanalytique(params){
            //console.log("test : " + params );
            var params = params || {};
            var getParams = {};
            getParams.balance_analytique = params.balance_analytique || undefined;
            /*if ($('#img_balance_analytique')[0]) {
                var getParams = { balance_analytique : 1 };  
            }*/
            var callback = params.callback || undefined;
            //console.log("toto : " + JSON.stringify(getParams));
            if( _this.selectedExercice ){
                getParams.id_exercice = _this.selectedExercice;
            }else if(document.getElementById('id_exercice')){
                getParams.id_exercice = document.getElementById('id_exercice').value;
            }

            var filtre_data = [];
            for(var index in _this.filtres) {
                if(_this.filtres[index].ignore == false) {
                filtre_data.push(_this.filtres[index]);
                }
            }
            getParams.filtres = filtre_data;

            $.getJSON( '/admin/compta/comptanalytique', getParams, function(data){
                //console.log(JSON.stringify(data));
                if(data && data.elements){
                    _this.comptanalytique = [];
                    var newBudgets = false;
                    var newAnalytiques = false;
                    var nb_oeuvre = 0;
                    var nb_fonctionnement = 0;
                    var currentBudgetsReference = undefined;
                    var currentAnalytiquesReference = undefined;
                    var budgets_fields = { id_budget: 'id_budget', libelle_budget: 'libelle_budget' };
                    var analytiques_fields = { id_analytique: 'id_analytique', libelle_analytique: 'libelle_analytique', nature: 'nature'};
                    var ecriture_fields = { id_ecriture: 'id_ecriture', id_journal: 'id_journal', libelle_ecriture: 'libelle_ecriture', date_ecriture: 'date_ecriture', operation: 'operation', piece: 'piece', debit_reel: 'debit_reel', credit_reel: 'credit_reel', id_compte: 'id_compte', ref_compte: 'ref_compte', libelle_compte: 'libelle_compte' };
                    for(var i = 0, l = data.elements.length; i < l; i++) {
                        if(data.elements[i].id_budget != currentBudgetsReference) {
                            newBudgets = true;
                            var objetBudgets = new Object();
                            currentBudgetsReference = data.elements[i].id_budget;
                            for(field in budgets_fields){
                                objetBudgets[budgets_fields[field]] = data.elements[i][field];
                            }
                            objetBudgets.nb_oeuvre = 0;
                            objetBudgets.nb_fonctionnement = 0;
                            objetBudgets.credit_reel = 0;
                            objetBudgets.debit_reel = 0;
                            objetBudgets.credit_reel_f = 0;
                            objetBudgets.debit_reel_f = 0;
                            objetBudgets.credit_reel_o = 0;
                            objetBudgets.debit_reel_o = 0;
                            objetBudgets.analytique = [];
                        }else{
                            newBudgets = false;
                        }

                        if(data.elements[i].id_analytique != currentAnalytiquesReference) {
                            newAnalytiques = true;
                            var objetAnalytiques = new Object();
                            currentAnalytiquesReference = data.elements[i].id_analytique;
                            for(field in analytiques_fields){
                                objetAnalytiques[analytiques_fields[field]] = data.elements[i][field];
                            }
                            objetAnalytiques.credit_reel = 0;
                            objetAnalytiques.debit_reel = 0;
                            objetAnalytiques.ecritures = [];
                        }else{
                            newAnalytiques = false;
                        }
                           if (objetAnalytiques.nature == 'oeuvres_sociales') {
                                    objetBudgets.nb_oeuvre++;
                                } else if (objetAnalytiques.nature == 'fonctionnement') {
                                    objetBudgets.nb_fonctionnement++; 
                                }

                        var objetEcriture = new Object();
                        for(field in ecriture_fields){
                            objetEcriture[ecriture_fields[field]] = data.elements[i][field];
                        }
                            objetEcriture.credit_reel = 0;
                            objetEcriture.debit_reel = 0;

                        if (data.elements[i].credit_reel != null) {
                            objetEcriture.credit_reel = parseFloat(data.elements[i].credit_reel);
                            objetAnalytiques.credit_reel += parseFloat(data.elements[i].credit_reel);
                            //objetBudgets.credit_reel += parseFloat(data.elements[i].credit_reel);
                            if (objetAnalytiques.nature == 'oeuvres_sociales'){
                              objetBudgets.credit_reel_o += parseFloat(data.elements[i].credit_reel);  
                            }
                            else if (objetAnalytiques.nature == 'fonctionnement'){
                                objetBudgets.credit_reel_f += parseFloat(data.elements[i].credit_reel);
                            }
                            objetBudgets.credit_reel += parseFloat(data.elements[i].credit_reel);
                            
                        }

                        if (data.elements[i].debit_reel != null) {
                            objetEcriture.debit_reel = parseFloat(data.elements[i].debit_reel);
                            objetAnalytiques.debit_reel += parseFloat(data.elements[i].debit_reel);
                            //objetBudgets.debit_reel += parseFloat(data.elements[i].debit_reel);
                            if (objetAnalytiques.nature == 'oeuvres_sociales'){
                              objetBudgets.debit_reel_o += parseFloat(data.elements[i].debit_reel);  
                            } else if (objetAnalytiques.nature == 'fonctionnement'){
                                objetBudgets.debit_reel_f += parseFloat(data.elements[i].debit_reel);
                            }
                            objetBudgets.debit_reel += parseFloat(data.elements[i].debit_reel);
                        }

                        var solde = data.elements[i].debit_reel - data.elements[i].credit_reel;
                        if(solde >= 0) {
                            objetEcriture.debit_reel = solde;
                            objetEcriture.credit_reel = 0;
                        } else {
                            objetEcriture.credit_reel = Math.abs(solde);
                            objetEcriture.debit_reel = 0; 
                        }                         

                        var solde_ecriture = objetEcriture.debit_reel - objetEcriture.credit_reel;
                        objetEcriture.solde = solde_ecriture;

                        var solde_analytique = objetAnalytiques.debit_reel - objetAnalytiques.credit_reel;
                        objetAnalytiques.solde = solde_analytique;

                        if (objetAnalytiques.nature == 'oeuvres_sociales'){
                            var solde_budget_o = objetBudgets.debit_reel_o - objetBudgets.credit_reel_o;
                            objetBudgets.solde_o = solde_budget_o;  
                        } else if (objetAnalytiques.nature == 'fonctionnement'){
                            var solde_budget_f = objetBudgets.debit_reel_f - objetBudgets.credit_reel_f;
                            objetBudgets.solde_f = solde_budget_f;
                        }
                        var solde_budget = objetBudgets.debit_reel - objetBudgets.credit_reel;
                        objetBudgets.solde = solde_budget;

                        var solde_balance_ecriture = data.elements[i].debit_reel - data.elements[i].credit_reel;
                        if (solde_balance_ecriture >= 0){
                            objetEcriture.solde_debit = Math.abs(solde_balance_ecriture);
                            objetEcriture.solde_credit = 0;
                        } else {
                            objetEcriture.solde_debit = 0;
                            objetEcriture.solde_credit = Math.abs(solde_balance_ecriture);
                        }

                        var solde_balance_analytique = objetAnalytiques.debit_reel - objetAnalytiques.credit_reel;
                        if (solde_balance_analytique >= 0){
                            objetAnalytiques.solde_debit = Math.abs(solde_balance_analytique);
                            objetAnalytiques.solde_credit = 0;
                        } else {
                            objetAnalytiques.solde_debit = 0;
                            objetAnalytiques.solde_credit = Math.abs(solde_balance_analytique);
                        }

                        if (objetAnalytiques.nature == 'oeuvres_sociales'){
                            var solde_balance_budget_o = objetBudgets.debit_reel_o - objetBudgets.credit_reel_o;
                            if (solde_balance_budget_o >= 0){
                                objetBudgets.solde_debit_o = Math.abs(solde_balance_budget_o);
                                objetBudgets.solde_credit_o = 0;
                            } else {
                                objetBudgets.solde_debit_o = 0;
                                objetBudgets.solde_credit_o = Math.abs(solde_balance_budget_o);
                            }  
                        } else if (objetAnalytiques.nature == 'fonctionnement'){
                            var solde_balance_budget_f = objetBudgets.debit_reel_f - objetBudgets.credit_reel_f;
                            if (solde_balance_budget_f >= 0){
                                objetBudgets.solde_debit_f = Math.abs(solde_balance_budget_f);
                                objetBudgets.solde_credit_f = 0;
                            } else {
                                objetBudgets.solde_debit_f = 0;
                                objetBudgets.solde_credit_f = Math.abs(solde_balance_budget_f);
                            }
                        }
                        var solde_balance_budget = objetBudgets.debit_reel - objetBudgets.credit_reel;
                        if (solde_balance_budget >= 0){
                            objetBudgets.solde_debit = Math.abs(solde_balance_budget);
                            objetBudgets.solde_credit = 0;
                        } else {
                            objetBudgets.solde_debit = 0;
                            objetBudgets.solde_credit = Math.abs(solde_balance_budget);
                        }
                        
                        objetAnalytiques.ecritures.push(objetEcriture);
                        if(newAnalytiques){
                            objetBudgets.analytique.push(objetAnalytiques);
                        }
                        if(newBudgets){

                            _this.comptanalytique.push(objetBudgets);
                        }
                        }
                    }
                    if(typeof callback == 'function'){
                        callback();
                    }
                    
                    //console.log('tata:', _this.comptanalytique)
                    _this.update();  
            })
        }
        getComptanalytique();
//// FIN BALANCE ANALYTIQUE & GRAND LIVRE ANALYTIQUE

        this.exercices = [];
        this.idExercices = {};

        function getExercices(){
            var getParams = { union: 1, id: 1 };
            if(_this.E_M) {
                _this.E_M.showLoader();
            } else {
                $('#loader').removeClass('hidden'); 
            }
            $.getJSON('/admin/compta/exercices', getParams, function (data){
                //console.log(data);
                if(data && data.elements){
                    var i, field, d; 
                    var l = data.elements.length;
                                            
                    var fields = { nom: 'nom', ecritures: 'ecritures' };
                    for(i=0; i<l; i++){
                        d = new Object();
                        for(field in fields){
                            d[fields[field]] = data.elements[i][field];
                            //console.log(d[fields['nom']]);
                            var nbr_ecritures;
                            _this.nbr_ecritures = parseFloat(d[fields['ecritures']]).toFixed();
                            var nom_exo;
                            _this.nom_exo = (d[fields['nom']]);
                        }
                        if(data.elements[i]['status'] === 'active') {
                            _this.nbExercicesActif++;
                        }
                        _this.idExercices[d['id']] = i;
                        _this.exercices.push(d);
                    }
                    _this.update();
                    if(_this.E_M) {
                        _this.E_M.removeLoader({});
                    } else {
                        $('#loader').addClass('hidden');
                    }

                    _this.loaded = true;
                }else{
                    if(data && data.error){
                    }
                }
            });
        }

        getExercices();

        this.ecritures = [];
        this.idEcritures = {};

        this.elements = [];
        this.idElements = {};

        function getEcritures() {
            var filtre_data = [];
            for(var index in _this.filtres) {
                if(_this.filtres[index].ignore == false) {
                    filtre_data.push(_this.filtres[index]);
                }
            }
            _this.elements = [];
            _this.total_credit = 0;
            _this.total_debit = 0;
            _this.solde_debit = 0;
            _this.solde_credit = 0;
            getElements({
                tag: _this,
                url: '/admin/compta/ecritures', 
                getParams:  { filtres: filtre_data },
                elements: _this.elements,
                idElements: _this.idElements,
                fieldAsId: 'num_operation',
                fields: { num_operation: 'num_operation',},
                fieldsForcedValue: { action: 'update_operation', },
                childsName: 'pieces',
                idChildsName: 'idPieces',
                childsFieldAsId: 'num_piece',
                childsfields: {id_ce: 'id', num_piece: 'num_piece', num_operation: 'num_operation', id_entreprise: 'id_entreprise', order_in_operation: 'order_in_operation', id_journal: 'id_journal',  id_exercice: 'id_exercice', date_enregistrement: 'date_enregistrement', status: 'status', lettrage: 'lettrage'},
                childsForcedValues: { action: 'update_ecriture', },
                grandChildsName: 'ecritures',
                idGrandChildsName: 'idEcritures',
                grandchildsfields: {id_ce: 'id', libelle: 'libelle', id_compte: 'id_compte', order_in_piece: 'order_in_piece', debit: 'debit', credit: 'credit', type: 'type', id_analytique: 'id_analytique', id_salarie: 'id_salarie', id_fournisseur: 'id_fournisseur', num_piece: 'num_piece', num_operation: 'num_operation', lettrage: 'lettrage'},
                grandChildsForcedValues: { action: 'update_ecriture', },

                initGet: function(tag){
                    if( tag.selectedExercice ){
                        this.getParams.id_exercice = tag.selectedExercice;
                    }else if(document.getElementById('id_exercice')){
                        this.getParams.id_exercice = document.getElementById('id_exercice').value;
                    }
                },

                end: function(tag){
                    console.log('_this ecritures: ', JSON.stringify(_this.elements));

                    /*debugtime-console.log('getEcritures AFTER be4up : ', Date.now() - _this.debugTime, ' actual : ', Date.now() -_this.actualTime);-debugTime*/
                    tag.update();

                    /*debugtime-console.log('getEcritures AFTER4 aftup : ', Date.now() - _this.debugTime, ' actual : ', Date.now() -_this.actualTime);-debugTime*/
                    tag.loaded = true;
                    console.log('_this ecritures: ', JSON.stringify(_this.elements));
                },
            });
        }

        

/*        this.exercices = [];
        this.idExercices = {};

        function getExercices(){
            var getParams = { union: 1, id: 1, analytique: 1 };
            if(_this.E_M) {
                _this.E_M.showLoader();
            } else {
                $('#loader').removeClass('hidden'); 
            }
            $.getJSON('/admin/compta/exercices', getParams, function (data){
                console.log(data);
                if(data && data.elements){
                    var i, field, d; 
                    var l = data.elements.length;
                                            
                    var fields = { date_debut: 'date_debut', date_fin: 'date_fin', ecritures: 'ecritures', nbr_analy_ecritures: 'nbr_analy_ecritures' };
                    for(i=0; i<l; i++){
                        d = new Object();
                        for(field in fields){
                            d[fields[field]] = data.elements[i][field];
                            console.log(d[fields['nbr_analy_ecritures']]);
                            var nbr_analy_ecritures;
                            _this.nbr_analy_ecritures = parseFloat(d[fields['nbr_analy_ecritures']]).toFixed();
                        }
                        if(data.elements[i]['status'] === 'active') {
                            _this.nbExercicesActif++;
                        }
                        _this.idExercices[d['id']] = i;
                        _this.exercices.push(d);
                    }
                    _this.update();
                    if(_this.E_M) {
                        _this.E_M.removeLoader({});
                    } else {
                        $('#loader').addClass('hidden');
                    }

                    _this.loaded = true;
                }else{
                    if(data && data.error){
                    }
                }
            });
        }

        getExercices();*/

// FILTRES

        function loadSelectize (selector) {
            var $select = $(selector).selectize({
                maxItems: 1,
                valueField: 'id',
                labelField: 'name',
                searchField: ['prenom', 'nom', 'numero_salarie'],
                sortField: [
                    {field: 'prenom', direction: 'asc'},
                    {field: 'nom', direction: 'asc'}
                ],
                options: _this.salaries ? _this.salaries : null,
                persist: false,
                openOnFocus: false,
                closeAfterSelect: true,
                onType: function (str) {
                    if (str === "") {
                        this.close();
                    }
                },
                render: {
                    item: function(item, escape) {
                        var name = formatName(item);
                        return '<div>' +
                            (name ? '<span class="name">' + escape(name) + '</span>' : '') +
                            (item.numero_salarie ? '<span class="email">' + escape(item.numero_salarie) + '</span>' : '') +
                        '</div>';
                    },
                    option: function(item, escape) {
                        var name = formatName(item);
                        var label = name || item.numero_salarie;
                        var caption = name ? item.numero_salarie : null;
                        return '<div>' +
                            '<span class="label">' + escape(label) + '</span>' +
                            (caption ? '<span class="caption">' + escape(caption) + '</span>' : '') +
                        '</div>';
                    }
                },
            });
            var selectize = $select[0].selectize;

            var hackToClose = false;
            selectize.on('item_remove', function(value, $item) {
                hackToClose = true;
            });
            selectize.on('dropdown_open', function($dropdown) {
                if ( hackToClose )
                    selectize.close();

                hackToClose = false;
            });
        }

         _this.app.loadScript('/js/admin/selectize.min.js','selectize_js',
            function () {
                _this.numToLoad--;
                if(_this.numToLoad <= 0) {
                    loadSelectize('#filtre_salarie');
                }
            }
        );

        this.total_debit = null;
        this.total_credit = null;
        this.solde_debit = null;
        this.solde_credit = null; 

        this.thingsToLoad = [ 'getSalarie', 'selectize'  ];
        this.numToLoad = this.thingsToLoad.length;

        function getSalaries(){
            var getParams = {};

            if(document.getElementById('id_exercice')){
                getParams.id_exercice = document.getElementById('id_exercice').value;
            } else if( _this.app.session.exercices.selected ){
                getParams.id_exercice = _this.app.session.exercices.selected;
            }
            //console.log('elements before: ' + JSON.stringify(_this.elements));
            $.getJSON('/admin/salaries/salaries', getParams, function (data){

                if(data && data.elements){
                    var i, field, d;
                    var l = data.elements.length;
                    var fields = {id: 'id', id_entreprise: 'id_entreprise', id_exercice: 'id_exercice', numero_salarie: 'numero_salarie', prenom: 'prenom', nom: 'nom', titre: 'titre',numero_et_voie: 'numero_et_voie', numero_appartement_ou_etage: 'numero_appartement_ou_etage', entree_batiment: 'entree_batiment', lieu_dit_boite_postale: 'lieu_dit_boite_postale', code_postal: 'code_postal',  ville: 'ville', pays: 'pays', identifiant_internet: 'identifiant_internet', mot_de_passe: 'mot_de_passe', nom_de_naissance: 'nom_de_naissance', date_de_naissance: 'date_de_naissance', situation_familiale: 'situation_familiale', telephone: 'telephone', portable: 'portable', email_personnel: 'email_personnel', email_professionnel: 'email_professionnel', banque: 'banque', titulaire: 'titulaire', rib: 'rib', iban: 'iban', bic: 'bic', option_1: 'option_1', option_2: 'option_2', option_3: 'option_3', option_4: 'option_4', option_5: 'option_5', option_6: 'option_6', option_7: 'option_7', option_8: 'option_8', option_9: 'option_9', option_10: 'option_10', quotient: 'quotient', solde: 'solde', reglement: 'reglement', participation_adherent: 'participation_adherent', participation_association: 'participation_association', visible: 'visible'};
                    for(i=0; i<l; i++){
                        d = new Object();
                        for(field in fields){
                            d[fields[field]] = data.elements[i][field];
                        }
                        _this.idSalaries[d['id']] = i;
                        _this.salaries.push(d);
                    }
                    _this.update();
                    console.log('salaries : ', _this.salaries);
                    _this.loaded = true;

                    _this.numToLoad--;

                    if(_this.numToLoad <= 0) {
                        _this.loadSelectize("#filtre_salarie");
                    }

                }else{
                    // TODO: no data elements, get and manage error!...
                }
            });
        }
        getSalaries();

        this.idFiltres = { filtre_journal: 0, filtre_compte: 1, filtre_analytique: 2, filtre_fournisseur: 3, filtre_salarie: 4, filtre_operation: 5, filtre_piece: 6, filtre_date_debut: 7, filtre_date_fin: 8, ec_valides: 9, ec_non_valides: 10, ec_lettrees: 11, ec_non_lettrees: 12, ec_du_jour: 13, filtre_libelle: 14, filtre_budget: 15 };

                this.elements = [];
        this.idElements = {};

        this.nbAddComptes = [
            {id: 1},
            {id: 2},
        ];

        /*this.fournisseurs = [
            { id: 1, libelle: 'rrrrr'},
            { id: 2, libelle: 'dddd'},
            { id: 3, libelle: 'zzzzz'},
            { id: 4, libelle: 'qqqqq'},
        ];
        this.idFournisseurs = {
            1: 0,
            2: 1,
            3: 2,
            4: 3,
        };*/

        this.convertDateToDb = function convertDateToDb(date){   
            var year = date.substr(6, 4);
            var month = date.substr(3,2);
            var day = date.substr(0,2);
            var convertedDate = year + "-" + month + "-" + day;
            return convertedDate;
        }

        this.convertDateToView = function convertDateToView(date){
            var convertedDate = '';
            if( ! date){
                convertedDate = "Date sans valeur";
            }else{
                var year = date.substr(0,4);
                var month = date.substr(5,2);
                var day = date.substr(8,2);
                var convertedDate = day + "/" + month + "/" + year;
            }
            return convertedDate;
        }

        filterChange (e) {
            e.preventDefault();
            e.preventUpdate = true;

            var $current = $(e.currentTarget);
            var currentVal = $current.val();
            var id = $current.attr('id');
            var filtre = _this.filtres[_this.idFiltres[id]];

            if(filtre.type == "select" || filtre.type == 'text') {
                if(currentVal != '') {
                    filtre.ignore = false;
                    filtre.value = currentVal;
                } else {
                    filtre.ignore = true;
                }
            } else if (filtre.type == 'checkbox') {
                if($current.is(':checked') == true) {
                    if(filtre.id == "ec_du_jour") {
                        var now = new Date();
                        var year = now.getFullYear();
                        var month = now.getMonth() + 1;
                        var day = now.getDate();
                        filtre.date_debut = year + "-" + month + "-" + day;
                    }
                    filtre.ignore = false;
                } else {
                    filtre.ignore = true;
                }
            } else {
            }
            var objet_non_lettre = _this.filtres[_this.idFiltres['ec_non_lettrees']];
            var objet_lettre = _this.filtres[_this.idFiltres['ec_lettrees']];
            var objet_valide = _this.filtres[_this.idFiltres['ec_valides']];
            var objet_non_valide = _this.filtres[_this.idFiltres['ec_non_valides']];

            if(objet_non_lettre.ignore == false && objet_lettre.ignore == false) {
                objet_non_lettre.ignore = true;
                objet_lettre.ignore = true;
            }
            if(objet_valide.ignore == false && objet_non_valide.ignore == false) {
                objet_valide.ignore = true;
                objet_non_valide.ignore = true;
            }
            var filtre_data = [];
            for(var index in _this.filtres) {
                if(_this.filtres[index].ignore == false) {
                    filtre_data.push(_this.filtres[index]);
                }
            }
            getEcritures();
        }



        if( ! _this.app.session.exercices){
            _this.app.session.exercices = {};
            _this.app.session.exercices.elements = [];
            _this.app.session.exercices.idElements = {};
            _this.exercices = _this.app.session.exercices.elements;
            _this.idExercices = _this.app.session.exercices.idElements;
            $.getJSON( '/admin/compta/exercices', {}, function(data){
                if(data && data.elements){
                    var l = data.elements.length;
                    var i, d; 
                    var fields = {id: 'id', nom: 'nom', is_default: 'is_default', date_debut: 'date_debut', date_fin: 'date_fin', prefixe: 'prefixe', mode: 'mode', status: 'status',};
                    for(i=0; i<l; i++){
                        d = new Object();

                        for(field in fields){
                            d[fields[field]] = data.elements[i][field];
                        }
                        if(d['id_default'] == 1){
                            _this.app.session.exercices.selected = d['id'];
                        }
                        _this.selectedExercice = _this.app.session.exercices.selected;
                        _this.idExercices[d['id']] = i;
                        _this.exercices.push(d);
                    }
                    //_this.numToLoad--;

                    _this.update();
                }else{
                    // TODO: no data elements, get and manage error!...
                }
            });
        }else{
            _this.exercices = _this.app.session.exercices.elements;
            //_this.numToLoad--;
        }

        this.journaux = [];
        this.idJournaux = {};

        function getJournaux(){
            var getParams = { };
            if( _this.selectedExercice ){
                getParams.id_exercice = _this.selectedExercice;
            }else if(document.getElementById('id_exercice')){
                getParams.id_exercice = document.getElementById('id_exercice').value;
            }

            $.getJSON( '/admin/compta/journaux', getParams, function(data){
                if(data && data.elements){
                    var l = data.elements.length;
                    var i, d; 
                    var fields = {id: 'id', libelle: 'libelle', visible: 'visible', id_compte: 'id_compte', _type: 'type', nature: 'nature'};
                    for(i=0; i<l; i++){
                        if(data.elements[i]['visible'] === 'visible') { 
                            d = new Object();
                            for(field in fields){
                                d[fields[field]] = data.elements[i][field];
                            }
                            _this.idJournaux[d['id']] = i;
                            _this.journaux.push(d);
                        }
                    }
                    //_this.numToLoad--;
                    //_this.update();
                }else{
                    // TODO: no data elements, get and manage error!...
                }
                //_this.numToLoad--;
            })
        }
        getJournaux();

       this.fournisseurs = [];
        this.idFournisseurs = {};

        function getFournisseurs() {
            var getParameters = { type_element: 'fournisseur' };
            var type = 'fournisseur';
            $.getJSON( '/admin/compta/fournisseurs', getParameters, function(data){
                //console.log('data ::::: ' + JSON.stringify(data))
                if(data && data.elements){
                    _this.fournisseurs = [];
                    _this.idFournisseurs = {};

                    var i, field, d;
                    var l = data.elements.length;
                    var fields = { id: 'id', libelle: 'libelle' };
                
                    for(i=0; i<l; i++){
                        d = new Object();
                        for(field in fields){
                            d[fields[field]] = data.elements[i][field];
                        }
                        if(type){
                            d['type'] = type;
                        }
                        _this.idFournisseurs[d['id']] = i;
                        _this.fournisseurs.push(d);
                    }         
                    _this.update();
                    //console.log('elements: ' + JSON.stringify(_this.fournisseurs))
                }else{
                    // TODO: no data elements, get and manage error!...
                }
                tag = null;
                url = null;
                fields = null;
                elements = null;
                idElements = null;
            });
        }

        getFournisseurs();

        this.entreprise = [];
        this.idEntreprise = {};

        function getEntreprise() {
            var getParameters = { type_element: 'entreprise' };
            var type = 'entreprise';
            $.getJSON( '/admin/site/parametres_entreprise', getParameters, function(data){
                //console.log('data ::::: ' + JSON.stringify(data))
                if(data && data.elements){
                    _this.entreprise = [];
                    _this.idEntreprise = {};

                    var i, field, d;
                    var l = data.elements.length;
                    var fields = { id: 'id', logo: 'logo' };
                    var logo = '';
                    for(i=0; i<l; i++){
                        d = new Object();
                        for(field in fields){
                            if (field == "logo") {
                                logo = data.elements[i][field];
                                console.log("logo ::::: " + logo)
                                $("#logo_entreprise").attr("src", "/img/uploads/entreprise/" + logo + "")
                            }
                            d[fields[field]] = data.elements[i][field];
                            console.log("d[fields[field]] : " + d[fields[field]]);
                        }
                        if(type){
                            d['type'] = type;
                        }
                        _this.idEntreprise[d['id']] = i;
                        _this.entreprise.push(d);
                    }         
                    _this.update();
                    //console.log('elements: ' + JSON.stringify(_this.entreprise))
                }else{
                    // TODO: no data elements, get and manage error!...
                }
                tag = null;
                url = null;
                fields = null;
                elements = null;
                idElements = null;
            });
        }

        getEntreprise();


        this.budgets = [];
        this.idBudgets = {};

        function getBudgets(){
            var getParams = { type_element: 'budget', visible: 'visible'};
            if( _this.selectedExercice ){
                getParams.id_exercice = _this.selectedExercice;
            }else if(document.getElementById('id_exercice')){
                getParams.id_exercice = document.getElementById('id_exercice').value;
            }

            $.getJSON( '/admin/compta/budgets', getParams, function(data){
                /*debugtime-console.log('getBudgets AFTER : ', Date.now() - _this.debugTime);-debugTime*/

                if(data && data.elements){
                    var l = data.elements.length;
                    var i, d; 
                    var fields = {id: 'id', id_entreprise: 'id_entreprise', nature: 'nature', libelle: 'libelle', id_exercice: 'id_exercice', visible: 'visible', sum_depense: 'sum_depense', sum_recette: 'sum_recette', analytique: 'analytique'};
                    for(i=0; i<l; i++){
                        //if(data.elements[i]['visible'] === 'visible') { 
                            d = new Object();
                            for(field in fields){
                                d[fields[field]] = data.elements[i][field];
                            }
                            _this.idBudgets[d['id']] = i;
                            _this.budgets.push(d);
                        //}
                    }
                    //_this.numToLoad--;
                    _this.update();
                }else{
                    // TODO: no data elements, get and manage error!...
                }
                //_this.numToLoad--;
            })
        }
        getBudgets();

        this.analytiques = [];
        this.idAnalytiques = {};

        function getAnalytiques(){
            var getParams = { type_element: 'analytique', visible: 'visible'};
            if( _this.selectedExercice ){
                getParams.id_exercice = _this.selectedExercice;
            }else if(document.getElementById('id_exercice')){
                getParams.id_exercice = document.getElementById('id_exercice').value;
            }

            $.getJSON( '/admin/compta/budgets', getParams, function(data){
                /*debugtime-console.log('getAnalytiques AFTER : ', Date.now() - _this.debugTime);-debugTime*/
                
                if(data && data.elements){
                    var l = data.elements.length;
                    var i, d; 
                    var fields = {id: 'id', libelle: 'libelle', visible: 'visible',};
                    for(i=0; i<l; i++){
                        d = new Object();

                        for(field in fields){
                            d[fields[field]] = data.elements[i][field];
                        }
                        _this.idAnalytiques[d['id']] = i;
                        _this.analytiques.push(d);
                    }
                    //_this.numToLoad--;
                    _this.update();
                }else{
                    // TODO: no data elements, get and manage error!...
                }
                //_this.numToLoad--;
            })
        }
        getAnalytiques();

        this.comptes = [];
        this.idComptes = {};

        function getComptes(){
            var getParams = { type_element: 'compte' };
            if(document.getElementById('id_exercice')){
                getParams.id_exercice = document.getElementById('id_exercice').value;
            }
            getParams.visible = 'visible';
            $.getJSON( '/admin/compta/comptes', getParams, function(data){
                /*debugtime-console.log('getComptes AFTER : ', Date.now() - _this.debugTime);-debugTime*/

                if(data && data.elements){
                    var l = data.elements.length;
                    var i, d; 
                    var fields = {id: 'id', id_sous_classe: 'id_sous_classe', reference: 'reference', libelle: 'libelle', id_bilan_debit: 'id_bilan_debit', id_bilan_credit: 'id_bilan_credit', categorie_bilan_debit: 'categorie_bilan_debit', categorie_bilan_credit: 'categorie_bilan_credit', id_compte_resultat: 'id_compte_resultat', visible: 'visible',};
                    var invisible_nb = 0;
                    for(i=0; i<l; i++){
                        if(data.elements[i]['visible'] === 'visible') {
                            d = new Object();

                            for(field in fields){
                                d[fields[field]] = data.elements[i][field];
                            }
                            _this.idComptes[d['id']] = i - invisible_nb;
                            _this.comptes.push(d);
                        } else {
                            invisible_nb += 1;
                        }
                    }
                    //_this.numToLoad--;
                    _this.update();
                }else{
                    // TODO: no data elements, get and manage error!...
                }
                //_this.numToLoad--;
            })
        }
        getComptes();

        filter(e){
            e.preventDefault();
            e.preventUpdate = true;
            if( _this.app.session.exercices.selected != $('#id_exercice').val()){
                _this.app.session.exercices.selected = $('#id_exercice').val();
            }
        }

        this.salaries = [];
        this.idSalaries = {};

        add_deleteCompte(e) {
            e.preventDefault();
            e.preventUpdate = true;

            deleteCompte('add', e);
        }

        update_deleteCompte(e){
            e.preventDefault();
            e.preventUpdate = true;

            deleteCompte('update', e);
        }

        setCompteRattachement(e) {
            e.preventDefault();
            e.preventUpdate = true;

            $('#id_compte_2').val(_this.journaux[_this.idJournaux[$(e.currentTarget).val()]].id_compte);
            if(_this.journaux[_this.idJournaux[$(e.currentTarget).val()]].type == "tresorerie") {
                if(_this.journaux[_this.idJournaux[$(e.currentTarget).val()]].id_compte !== undefined)
                    $('#id_compte_2').attr("disabled", "disabled");
            } else {
                $('#id_compte_2').removeAttr("disabled");
            }
        }

        saveElementAndNew(e) {
            e.preventDefault();
            e.preventUpdate = true;

            if(_this.add_debit_total - _this.add_credit_total == 0) {
                saveElement(e, true);
            }
        }


        save(e) {
            e.preventDefault();
            e.preventUpdate = true;

            if( !e.item ) {
                if(_this.add_debit_total - _this.add_credit_total == 0) {
                    saveElement(e, false);
                }
            } else {
                console.log('eelse');
                changeDebitCredit_edit('save', e);
                if(e.item.edit_debit_total - e.item.edit_credit_total == 0) {
                    saveElement(e, false);
                }
            }
        }

        function checkRequiredValue(element, missingParameters, selector) {
            if(element === '') {
                $(selector).addClass('required');
                return(true);
            } else {
                $(selector).removeClass('required');
                if(missingParameters === false) {
                    return(false);
                } else {
                    return(true);
                }
            }
        }

        function saveElement(e, resave){
            var params = { hideClass: 'hidden', }
            var isEdit = false;

            var field, fieldById, suffixOperationId = '', data = {};
            var numOperation, numPiece, numElement, numParentElement;
            var newOperation, newPiece, newEcriture;
            var $ecritures, ecritures, idEcritures;
            /*var fieldChilds = ['libelle', 'id_compte', 'debit', 'credit', 'id_fournisseur', 'id_salarie', 'id_analytique'];
            var ecrituresFields = ['libelle', 'id_compte', 'debit', 'credit', 'id_fournisseur', 'id_salarie', 'id_analytique'];*/
            var action, id_exercice, libelle;
            var tag = _this;
            var elements = _this.elements;
            var idElements = _this.idElements;
            var parentElement, element;
            var orderInOperation;
            var ecrituresByOrderInPiece = {};
            var missingParameters = false;
            if( e.item ){
                var item = e.item;
                //var copyItem = jQuery.extend(true, {}, e.item);
                isEdit = true;
                numOperation = item.num_operation;
                numPiece = item.num_piece;
                parentElement = elements[ idElements[ numOperation ] ];
                numElement = parentElement['idPieces'][ numPiece ];
                element = parentElement['pieces'][ numElement ];
                ecritures = element.ecritures;
                idEcritures = element.idEcritures;

                $ecritures = $('.ecritures_ids_' + numOperation + '_' + numPiece, $('#' + numOperation));
                action = 'update_operation';
                suffixOperationId = '_' + numOperation;
                orderInOperation = item.order_in_operation;
                /*var id_salarie = document.getElementById('id_salarie' + suffixOperationId).value;
                var id_fournisseur = document.getElementById('id_fournisseur' + suffixOperationId).value;*/
            }else{
                numParentElement = elements.length;
                // we create only one element
                numElement = 0;
                elements.push(new Object());
                parentElement = elements[numParentElement];
                parentElement.pieces = [];
                parentElement.idPieces = {};
                parentElement.pieces[ numElement ] = {};
                element = parentElement.pieces[0];

                element.ecritures = [];
                element.idEcritures = {};

                ecritures = element.ecritures;
                idEcritures = element.idEcritures;

                /***************************************************
                numOperation = _this.app.makeId(idElements);
                element.num_operation = numOperation;
                element.id = numOperation;

                idElements[ numOperation ] = numElement;
                ***************************************************/

                $ecritures = $('.ecritures_ids', $('#add_piece'));
                action = 'add_operation';
                id_exercice = $('#id_exercice').val();//tag.id_exercice.value;
                element.id_exercice = id_exercice;
                orderInOperation = 0;
            }
            data.action = action;
            var id_journal = document.getElementById('id_journal' + suffixOperationId).value;
            var date_enregistrement = document.getElementById('date_enregistrement' + suffixOperationId).value;
            missingParameters = checkRequiredValue(id_journal, missingParameters, '#id_journal' + suffixOperationId);
            missingParameters = checkRequiredValue(date_enregistrement, missingParameters, '#date_enregistrement' + suffixOperationId);
            element.action = action;
            element.id_journal = id_journal;
            /*element.id_salarie = id_salarie;
            element.id_fournisseur = id_fournisseur;*/
            element.date_enregistrement = _this.convertDateToView(date_enregistrement);
            element.order_in_operation = orderInOperation;

            data.ecritures = [];
            $ecritures.each(function (index){
                // if isEdit => id from DB
                // if ! isEdit || action == add_operation  => id generated from app
                var id;
                var i = data.ecritures.length;
                var action = $(this).attr('action');
                data.ecritures.push(new Object());
                var dataEcriture = data.ecritures[i];
                var suffixEcritureId
                var ecriture;

                /* 
                    TODO: 
                        new ecriture if isEdit is true, have no db_id attribute ...
                */
                if( isEdit ){
                    id = $(this).attr('db_id');
                    suffixEcritureId = suffixOperationId + '_' + (id || '');

                    if( action === 'add_ecriture' ){
                        ecritures.push(new Object);
                        ecriture = ecritures[ ecritures.length - 1 ];
                    }else{
                        ecriture = ecritures[ idEcritures[id] ];
                    }
                }else{
                    ecritures.push(new Object);
                    ecriture = ecritures[ ecritures.length - 1 ];
/*********************************
                    id = _this.app.makeId( idEcritures );
                    ecriture.id = id;
                    idEcritures[ id ] = ecritures.length - 1;
*************************************/
                    suffixEcritureId = '_' + (i + 1);
                }

                /*if( ! ecriture.analytiques ){
                    ecriture.analytiques = [];
                    ecriture.idAnalytiques = {};
                }*/

                var id_compte = document.getElementById('id_compte' + suffixEcritureId).value;
                missingParameters = checkRequiredValue(id_compte, missingParameters, '#id_compte' + suffixEcritureId);
                var debit = document.getElementById('debit' + suffixEcritureId).value;
                missingParameters = checkRequiredValue(debit, missingParameters, '#debit' + suffixEcritureId);
                debit = parseFloat(debit).toFixed(2);
                var credit = document.getElementById('credit' + suffixEcritureId).value;
                missingParameters = checkRequiredValue(credit, missingParameters, '#credit' + suffixEcritureId);
                credit = parseFloat(credit).toFixed(2);
                var id_salarie = document.getElementById('id_salarie' + suffixEcritureId).value;
                var id_fournisseur = document.getElementById('id_fournisseur' + suffixEcritureId).value;
                // analytique 
                var id_analytique = document.getElementById('id_analytique' + suffixEcritureId).value;

                libelle = document.getElementById('libelle' + suffixEcritureId).value;

                missingParameters = checkRequiredValue(libelle, missingParameters, '#libelle' + suffixEcritureId);
                dataEcriture.action = action;
                if(action == 'add_ecriture') {
                    dataEcriture.id_exercice = $('#id_exercice').val();
                }
                dataEcriture.num_operation = numOperation;

                dataEcriture.num_piece = numPiece;

                dataEcriture.id = id;
                dataEcriture.order_in_operation = orderInOperation;
                dataEcriture.order_in_piece = i;
                dataEcriture.date_enregistrement = date_enregistrement;
                dataEcriture.id_journal = id_journal;
                dataEcriture.id_fournisseur = id_fournisseur;
                dataEcriture.id_analytique = id_analytique;
                dataEcriture.id_salarie = id_salarie;
                dataEcriture.libelle = libelle;
                dataEcriture.id_compte = id_compte;
                dataEcriture.debit = debit;
                dataEcriture.credit = credit;

                if( id_exercice ){
                    dataEcriture.id_exercice = id_exercice;
                }
                ecriture.action = action;

                if(action == 'add_ecriture') {
                    ecriture.id_exercice = $('#id_exercice').val();
                }

                ecriture.order_in_operation = orderInOperation;
                ecriture.order_in_piece = i;

                ecrituresByOrderInPiece[i] = ecriture;

                ecriture.date_enregistrement = date_enregistrement;
                ecriture.id_journal = id_journal;
                ecriture.id_fournisseur = id_fournisseur;
                ecriture.id_salarie = id_salarie;
                ecriture.id_analytique = id_analytique;
                ecriture.libelle = libelle;
                ecriture.id_compte = id_compte;
                ecriture.debit = debit;
                ecriture.credit = credit;

                //var suffixAnalytiqueId;
                /*$('.analytique_ids'  + suffixEcritureId).each(function (index){
                    dataEcriture.analytiques.push(new Object());
                    var j = dataEcriture.analytiques.length;
                    var dataAnalytique = dataEcriture.analytiques[j];
                    var id_analytique = $(this).attr('id');
                    var suffixAnalytiqueId = suffixEcritureId + '_' + id_analytique;
                    dataAnalytique.id = document.getElementById('id_analytique' + suffixAnalytiqueId).value;
                    dataAnalytique.debit = document.getElementById('debit' + suffixAnalytiqueId).value;
                    dataAnalytique.credit = document.getElementById('credit' + suffixAnalytiqueId).value;
                    dataAnalytique.order_ecriture = j;
                });*/
                
            });
            if(missingParameters === false) {
                $.ajax('/admin/compta/ecritures', {
                    data : data,
                    type : 'POST',
                    dataType: 'json',
                    success: function (result, textStatus, jqXHR){
                        if(!result.error) {
                            if( !isEdit ){
                                if(!resave) {
                                    $('.block_info_montant').show();
                                    if($('.liste-ecritures-title').hasClass('closed')) {
                                        $('.liste-ecritures-title').removeClass('closed').addClass('opened');
                                        $('.slide-up', '.liste-ecritures').slideToggle('fast');
                                    }
                                    var a = $('.add_ecriture.block-slider header');
                                    var b = [];
                                    b.target = a[0];
                                    _this.E_M.showContents(b);
                                    _this.add_debit_total = (0).toFixed(2);
                                    _this.add_credit_total = (0).toFixed(2);
                                    _this.update();

                                    var fields= ['libelle', 'id_journal', 'date_enregistrement', ];
                                    var l = fields.length;
                                    for(i=0; i<l; i++){
                                        field = fields[i];
                                        $('.' + field, '#add_piece' ).val( '' );
                                    }
                                    $('#journalCheckBox, #dateCheckBox, #libelleCheckBox').removeAttr('checked');
                                    $('input, select', '#add_piece').removeClass('required');

                                    element.num_operation = result.ids[0].num_operation;
                                    element.num_piece = result.ids[0].num_piece;
                                } else {
                                    _this.add_debit_total = (0).toFixed(2);
                                    _this.add_credit_total = (0).toFixed(2);
                                    _this.nbAddComptes = [
                                    {id: 1},
                                    {id: 2},
                                    ];
                                    _this.update();

                                    var fields= [];
                                    if(!$('#journalCheckBox').is(':checked'))
                                        fields.push('id_journal');

                                    if(!$('#dateCheckBox').is(':checked'))
                                        fields.push('date_enregistrement');

                                    if(!$('#libelleCheckBox').is(':checked')) {
                                        fields.push('libelle');
                                    } else {
                                        $('.liste-add-ecriture .add_ecriture_infos .libelle').val($('#libelle').val());
                                    }

                                    var l = fields.length;
                                    for(i=0; i<l; i++){
                                        field = fields[i];
                                        $('.' + field, '#add_piece' ).val( '' );
                                    }
                                    $('input, select', '#add_piece').removeClass('required');

                                    element.num_operation = result.ids[0].num_operation;
                                    element.num_piece = result.ids[0].num_piece;
                                }
                            } else {
                                for(var i = ecritures.length - 1; i >= 0; i--) {
                                    if(ecritures[i].id == '-1' || ecritures[i].action == 'delete_ecriture') {
                                        ecritures.splice(i, 1);
                                    }
                                }
                            }

                            if(result.ids){
                                if( isEdit ){
                                    var $container = $('#piece_' + numPiece);
                                    var $editContainer = $('#piece_' + numPiece + '_edit');
                                    $('.show_infos', $container).removeClass(params.hideClass);
                                    $editContainer.addClass(params.hideClass);
                                    $('.ecriture.hidden[action=delete_ecriture]', $editContainer).remove();
                                }else{
                                }
                                $('input, select', '#piece_' + numPiece + '_edit').removeClass('required');
                                var ids = result.ids;
                                var i, e, resultId, l = ids.length, currentNumPiece;
                                for(i=0; i<l; i++){
                                    resultId = ids[i];
                                    e = ecrituresByOrderInPiece[ resultId['order_in_piece'] ];
                                    e.id = resultId['id'];
                                    idEcritures[ resultId['id'] ] = parseFloat(resultId['order_in_piece']);

                                    if(i === 0){
                                        element.num_operation = resultId['num_operation'];
                                        parentElement.num_operation = resultId['num_operation'];

                                        //Demander à Olivier à quoi sert cette ligne
                                        if(! isEdit) {
                                            idElements[ resultId['num_operation'] ] = numParentElement;
                                        }
                                    }

                                    if( currentNumPiece !== resultId['num_piece']){
                                        element.num_piece = resultId['num_piece'];
                                        element.id = resultId['num_piece'];
                                        parentElement.id = resultId['num_operation']
                                        parentElement.idPieces[ resultId['num_piece'] ] = numElement;
                                    }
                                }
                /************************
                result: {
                "messages":[
                {"affectedRows":"1","insertId":"0"},
                {"affectedRows":"1","insertId":"0"}
                ],
                "ids":[
                {"id":"1","num_operation":"1","order_in_operation":"0","order_in_piece":"0"},
                {"id":"2","num_operation":"1","order_in_operation":"0","order_in_piece":"1"}
                ]
                }
                element.id = result.id;
                elements.push(element);
                numElement = elements.length - 1;
                idElements[result.id] = numElement;
                *************************/
                                tag.update();
                            }else if(result.messages){
                                // TODO:
                            }else if(result.error){
                                // TODO:
                            }
                            tag = null;
                        }
                    }
                }).done(function(){
                    console.log('done!...');
                    tag = null;
                }).fail(function(){
                    console.log('fail!...');
                    tag = null;
                }); //, 'json'
            } else if( missingParameters === true && ! isEdit ) {
                _this.elements.pop();
            } else if( missingParameters === true && isEdit ) {
                ecritures = item.ecritures;
                // suppression des clones des lignes ajoutées
                if(ecritures[ecritures.length - 1].action === "add_ecriture")
                    ecritures.pop();
                //tag.update();
            }
        }

        selectExercice(e){
            e.preventDefault();
            e.preventUpdate = true;

            
        }

        filter(e){
            e.preventDefault();
            e.preventUpdate = true;
            if( _this.app.session.exercices.selected != $('#id_exercice').val()){
                _this.app.session.exercices.selected = $('#id_exercice').val();
            }
        }


        addCompte(e) {
            e.preventDefault();
            e.preventUpdate = true;
            addLineCompte('add', e);
        }

        addCompte_edit(e) {
            e.preventDefault();
            e.preventUpdate = true;
            addLineCompte('edit', e);
        }

        function addLineCompte(action, e) {
            if(action == 'add') {
                var newItem = { id: _this.nbAddComptes.length + 1};
                _this.nbAddComptes.push(newItem);
            } else if (action == 'edit') {
                var tmp = {
                            id: -1,
                            debit: 0,
                            credit: 0,
                            action: 'add_ecriture',
                        };
                console.log('this all : ', _this.idElements, 'this test : ', _this.idElements[14], 'this : ', _this.idElements[e.item.id], ' id : ', e.item.id);
                _this.elements[_this.idElements[e.item.id]].pieces[0].ecritures.push(tmp);
            }
            _this.update();
        }

        showComplementaire(e){
            e.preventDefault();
            e.preventUpdate = true;

            /*
             * 6 et 7 analytique
             * 401 fournisseurs
             * 411 client/salarie
             */
            var value = $(e.currentTarget).val();
            var reference = $('option[value=' + value + ']', e.currentTarget).attr('reference');
            var idTarget = $(e.currentTarget).attr('id');
            var selector = "#" + idTarget.replace(/compte/g, 'salarie');

            var block_complementaire = $(e.currentTarget.parentNode.parentNode);
            if (reference[0] == 6 || reference[0] == 7) {
                $('.info_analytique', block_complementaire).removeClass('hidden');
                $('.info_salarie', block_complementaire).addClass('hidden');
                $('.info_fournisseur', block_complementaire).addClass('hidden');    
            } else if (reference.substring(0, 3) == "411") {
                $('.info_analytique', block_complementaire).addClass('hidden');
                $('.info_salarie', block_complementaire).removeClass('hidden');
                $('.info_fournisseur', block_complementaire).addClass('hidden');
                loadSelectize(selector);
            } else if (reference.substring(0, 3) == "401") {
                $('.info_analytique', block_complementaire).addClass('hidden');
                $('.info_salarie', block_complementaire).addClass('hidden');
                $('.info_fournisseur', block_complementaire).removeClass('hidden');
            } else {
                $('.info_analytique', block_complementaire).addClass('hidden');
                $('.info_salarie', block_complementaire).addClass('hidden');
                $('.info_fournisseur', block_complementaire).addClass('hidden');
            }
        }


        this.getCompteReference = function getCompteReference(num_piece) {
            
        }

        showContents(e){
            e.preventDefault();
            e.preventUpdate = true;

            if(_this.E_M){
                if($(e.target).hasClass('closed') && $(e.target).hasClass('add-ecriture-title')) {
                    $('.block_info_montant').hide();
                    _this.nbAddComptes = [
                        {id: 1},
                        {id: 2},
                    ];
                    _this.update();
                    if($('.liste-ecritures-title').hasClass('opened')) {
                        $('.liste-ecritures-title').removeClass('opened').addClass('closed');
                        $('.slide-up', $('.liste-ecritures')).slideToggle('fast');
                    }
                } else if($(e.target).hasClass('opened') && $(e.target).hasClass('add-ecriture-title')){
                    $('.block_info_montant').show();
                    if($('.liste-ecritures-title').hasClass('closed')) {
                        $('.liste-ecritures-title').removeClass('closed').addClass('opened');
                        $('.slide-up', $('.liste-ecritures')).slideToggle('fast');
                    }
                }
                _this.E_M.showContents(e);
            }
        }

        function getElements(params){
            if( ! params || ! params.url || ! params.fields || ! params.tag ){
                throw new Error('getElements: missing parameters!...');
            }

            var url = params.url;
            var tag = params.tag || _this;
            this.getParams = params.getParams || {};
            if(params.initGet && typeof params.initGet === 'function'){
                var initGet = params.initGet.bind(this);
                initGet(tag);
            }
            $.getJSON(url, this.getParams, function (data){
                /*debugtime-console.log('getEcritures AFTER : ', Date.now() - _this.debugTime, ' actual : ', Date.now() - _this.actualTime);
                _this.debugTime = Date.now();-debugTime*/

                console.log(data);
                if(data && data.elements){
                    if(params.initData && typeof params.initData === 'function'){
                        var initData = params.initData.bind(this);
                        initData(tag);
                    }
                    var i, field, d, subElement; 
                    var l = data.elements.length;
                    var numElement = 0;
                    var elements = params.elements || tag.elements;
                    var idElements = params.idElements || tag.idElements;
                    var fields = params.fields;
                    var fieldsForcedValues = params.fieldsForcedValues || undefined;
                    var childsName = params.childsName || undefined;
                    var grandChildsName = params.grandChildsName || undefined;
                    var idChildsName = params.idChildsName || undefined;
                    var idGrandChildsName = params.idGrandChildsName || undefined;
                    var childsfields = params.childsfields || undefined;
                    var grandchildsfields = params.grandchildsfields || undefined;
                    var childsForcedValues = params.childsForcedValues || undefined;
                    var grandChildsForcedValues = params.grandChildsForcedValues || undefined;

                    var fieldAsId = params.fieldAsId || 'id';
                    var childsFieldAsId = params.childsFieldAsId || 'id';
                    var grandChildsFieldAsId = params.grandChildsFieldAsId || 'id';

                    var haveChilds = ( childsName && idChildsName ? true : false );
                    var haveGrandChilds = ( grandChildsName && idGrandChildsName ? true : false );

                    var isNewElement, numChild, currentElementId;
                    var isNewChild, numGrandChild, currentChildId;
                    var currentGrandChildId;

                    var childs, child, idChilds;
                    var grandChilds, grandChild, idGrandChilds;

                    for(i=0; i<l; i++){
                        if( currentElementId !== data.elements[i][ fieldAsId ]){
                            currentElementId = data.elements[i][ fieldAsId ];
                            isNewElement = true;
                        }else{
                            isNewElement = false;
                        }

                        if( haveChilds ){
                            if(currentChildId !== data.elements[i][ childsFieldAsId ] ){
                                currentChildId = data.elements[i][ childsFieldAsId ];
                                isNewChild = true;

                                if( isNewElement ){
                                    numChild = 0;
                                }else{
                                    numChild++;
                                }

                                if( haveGrandChilds ){
                                    numGrandChild = 0;
                                }
                            }else{
                                isNewChild = false;
                                if( haveGrandChilds ){
                                    numGrandChild++;
                                }
                            }

                            if( haveGrandChilds ){
                                currentGrandChildId = data.elements[i][ grandChildsFieldAsId ];
                            }
                        }

                        if( isNewElement ){
                            d = new Object();

                            // init id parent object
                            idElements[ currentElementId ] = numElement;
                            d['id'] = currentElementId;

                            d[ childsName ] = [];
                            d[ idChildsName ] = {};
                            childs = d[ childsName ];
                            idChilds = d[ idChildsName ];
                        }else{
                            // get parent object reference
                            d = elements[ idElements[ currentElementId ] ];
                        }

                        if( isNewChild ){
                            childs[ numChild ] = {};
                            idChilds[ currentChildId ] = numChild;

                            child = childs[ numChild ];

                            child['id'] = currentChildId;

                            if( haveGrandChilds ){
                                child[ grandChildsName ] = [];
                                child[ idGrandChildsName ] = {};
                                grandChilds = child[ grandChildsName ];
                                idGrandChilds = child[ idGrandChildsName ];
                              }                         
                        }

                        if( haveGrandChilds ){
                            grandChilds[ numGrandChild ] = {};
                            idGrandChilds[ currentGrandChildId ] = numGrandChild;
                            grandChild = grandChilds[ numGrandChild ];
                        }

                        if( isNewElement ){
                            for(field in fields){
                                d[fields[field]] = data.elements[i][field];
                            }
                            d['display'] = true;
                            if( fieldsForcedValues ){
                                for(forcedField in fieldsForcedValues){
                                    d[forcedField] = fieldsForcedValues[forcedField];
                                }                           
                            }

                        }

                        if( childsfields && isNewChild ){
                            for( childsfield in childsfields ){
                                if(childsfield !== 'date_enregistrement')
                                    child[ childsfields[ childsfield ] ] = data.elements[i][childsfield];
                                else
                                    child[ childsfields[ childsfield ] ] = _this.convertDateToView(data.elements[i][childsfield]);
                            }
                            if( childsForcedValues ){
                                for(forcedField in childsForcedValues){
                                    child[forcedField] = childsForcedValues[forcedField];
                                }
                            }
                        }

                        if( grandchildsfields  ){
                            for( grandchildfield in grandchildsfields ){
                                grandChild[ grandchildsfields[ grandchildfield ] ] = data.elements[i][grandchildfield];
                            }

                            if(_this.total_debit === null) {
                                _this.total_debit = 0;
                            }
                            _this.total_debit = parseFloat(_this.total_debit) + parseFloat(data.elements[i]['debit']);
                            _this.total_debit = parseFloat(_this.total_debit).toFixed(2);

                            if(_this.total_credit === null) {
                                _this.total_credit = 0;
                            }
                            _this.total_credit = parseFloat(_this.total_credit) + parseFloat(data.elements[i]['credit']);
                            _this.total_credit = parseFloat(_this.total_credit).toFixed(2);

                            if( grandChildsForcedValues ){
                                for(forcedField in grandChildsForcedValues){
                                    grandChild[forcedField] = grandChildsForcedValues[forcedField];
                                }
                            }
                        }


                        if(params.each && typeof params.each === 'function'){
                            var each = params.each.bind(this);
                            each(tag);
                        }

                        if( ! haveChilds || isNewElement ){
                    /************************************************************
                            // if an element already exist, we should replace it
                            if( typeof idElements[d['id']] === 'undefined'){
                                idElements[d['id']] = i;
                                elements.push(d);
                            }else{
                                elements[ idElements[d['id']] ] = d;
                            }
                    *************************************************************/

                            elements.push(d);
                        }
                        if( isNewElement ){
                            numElement++;
                        }
                    }
                    /*debugtime-console.log('getEcritures AFTER2 for : ', Date.now() - _this.debugTime, ' actual : ', Date.now() -_this.actualTime);
                    _this.debugTime = Date.now();-debugTime*/
               
                    /*debugtime-console.log('getEcritures AFTER3 getSolde : ', Date.now() - _this.debugTime, ' actual : ', Date.now() -_this.actualTime);
                    _this.debugTime = Date.now();-debugTime*/
                    if(params.end && typeof params.end === 'function'){
                        var end = params.end.bind(this);
                        end(tag);
                    }
                    /*debugtime-console.log('getEcritures AFTER4 update : ', Date.now() - _this.debugTime, ' actual : ', Date.now() -_this.actualTime);-debugTime*/
                }else{
                    // TODO: no data elements, get and manage error!...
                    if(params.error && typeof params.error === 'function'){
                        var error = params.error.bind(this);
                        error(tag);
                    }
                }
                //_this.update();
                if (url == '/admin/compta/impressions') {
                    updateEcritures();
                }
                /*debugtime-console.log('getEcritures AFTER5 updateecritures : ', Date.now() - _this.debugTime, ' actual : ', Date.now() -_this.actualTime);-debugTime*/

                tag = null;
                url = null;
                fields = null;
                elements = null;
                idElements = null;
                initGet = null;
                end = null;
            });
        }

        function updateEcritures() {
            // set compte type ref
            var reference = "";
            for(index_e in _this.elements) {
                var credit = debit = 0;
                for(index_p in _this.elements[index_e].pieces) {
                    for(index in _this.elements[index_e].pieces[index_p].ecritures) {
                        debit += parseFloat(_this.elements[index_e].pieces[index_p].ecritures[index].debit);
                        credit += parseFloat(_this.elements[index_e].pieces[index_p].ecritures[index].credit);
                        for(index_c in _this.comptes) {
                            if(_this.elements[index_e].pieces[index_p].ecritures[index].id_compte == _this.comptes[index_c].id)
                                reference = _this.comptes[index_c].reference;
                        }
                        if(reference != "") {
                            if (reference[0] === '6' || reference[0] === '7') {
                                _this.elements[index_e].pieces[index_p].ecritures[index].type_compte = "analytique";
                            } else if (reference.substring(0, 3) === "411") {
                                _this.elements[index_e].pieces[index_p].ecritures[index].type_compte = "salarie";
                            } else if (reference.substring(0, 3) === "401") {
                                _this.elements[index_e].pieces[index_p].ecritures[index].type_compte = "fournisseur";
                            }
                        }
                    }
                    _this.elements[index_e].pieces[index_p].edit_debit_total = debit;
                    _this.elements[index_e].pieces[index_p].edit_credit_total = credit;
                }
            }
            _this.update();
        }

        function getParametresComptes(){
            var getParams = { };
            if( _this.selectedExercice ){
                getParams.id_exercice = _this.selectedExercice;
            }else if(document.getElementById('id_exercice')){
                getParams.id_exercice = document.getElementById('id_exercice').value;
            }

            $.getJSON( '/admin/compta/parametres', getParams, function(data){
                console.log('getPARAMETRES AFTER : ', Date.now() - _this.debugTime);

                if(data && data.elements){
                    _this.parametresCompte = data.elements[0];
                    _this.prefixe_num_op = data.elements[0].prefixe_numero_operations;
                    _this.prefixe_num_pieces = data.elements[0].prefixe_numero_pieces;
                    //_this.numToLoad--;
                    _this.update();
                }else{
                    // TODO: no data elements, get and manage error!...
                }
                //_this.numToLoad--;
            })
        }
        //getParametresComptes();

        saveStatus(e) {
            e.preventDefault();
            e.preventUpdate = true;

            if(_this.solde_debit == 0 && _this.solde_credit == 0) {
                console.log("elements : ", _this.elements);
                var num_operation = [];
                for(var index in _this.elements) {
                    num_operation.push(_this.elements[index]['num_operation']);
                }
                data = { action: 'update_status', status: 'active', num_operation: num_operation},
                $.ajax('/admin/compta/ecritures', {
                    data : data,
                    type : 'POST',
                    dataType: 'json',
                    success: function (result, textStatus, jqXHR){
                        console.log("ecritures validées");
                        getEcritures();
                    }
                }).done(function(){
                    console.log('done!...');
                    tag = null;
                }).fail(function(){
                    console.log('fail!...');
                    tag = null;
                }); //, 'json'
            } else {
                console.log("modal error, ne peut pas valider car solde est different de 0");
            }
        }

        resetFiltre(e) {
            e.preventDefault();
            e.preventUpdate = true;

            for(var index in _this.filtres) {
                _this.filtres[index].ignore = true;
                if(_this.filtres[index].id == 'ec_non_valides') {
                    _this.filtres[index].ignore = false;
                }
            }
            var filtre = $('fieldset.filtre');
            $('input[type=text], select', filtre).val('');
            $('input[type=checkbox]', filtre).prop('checked', false);
            $('#ec_non_valides').prop('checked', true);

            getEcritures();
        }

//// FIN FILTRES

    // NEW FILTRES

        function loadTag(params) {
            var selector = params.selector;
            var tagName = params.tagName;
            var opt = { parentTag: _this };
            var url = params.url;
            var newselector = "newtag";
            var mountTag = document.createElement('div');

            if(params.newselector) {
                newselector = params.newselector;
            }
            if(params.tagContainer) {
                mountTag.setAttribute('id', newselector);
                $(params.tagContainer).append(mountTag);
            }
            if(params.opt) {
                opt = params.opt;
            }
            if( (params.selector || params.tagContainer) && params.tagName && params.url ) {
                riot.compile( url, function() {
                    mounted = riot.mount( params.tagContainer ? '#' + newselector : selector, tagName, opt);
                });
            }
        }

        this.on('mount', function(){
            //loadDateTemplate();
            var params = { selector: '.filtre', tagName: 'filtre-ecriture', url: '/js/tag/admin/compta/filtre-ecriture.html', opt: { parentTag: _this, fieldset: true } };
            loadTag(params);
        });

    // FIN FILTRES

        this.update();

        showContents(e){
            e.preventDefault();
            e.preventUpdate = true;
            if(_this.E_M){
                //console.log(e.target);
                _this.E_M.showContents(e);
            }
        };

// FONCTION IMPRIMER
    (function($) { 
    // Initialization
    $.fn.printPreview = function() {
        this.each(function() {
            $(this).bind('click', function(e) {
                e.preventDefault();
                if (!$('#print-modal').length) {
                    $.printPreview.loadPrintPreview();
                }
            });
        });
        return this;
    };

    // Private functions
    var mask, size, print_modal, print_controls;
    $.printPreview = {
        loadPrintPreview: function() {
            // Declare DOM objects
            print_modal = $('<div id="print-modal"></div>');
            print_controls = $('<div id="print-modal-controls">' + 
                                    '<a href="#" class="print" title="Print page">Imprimer la Page</a>' +
                                    '<a href="#" class="close" title="Close print preview">Fermer</a>').hide();
            var print_frame = $('<iframe id="print-modal-content" scrolling="no" border="0" frameborder="0" name="print-frame" />');
            // Raise print preview window from the dead, zooooooombies
            print_modal
                .hide()
                .append(print_controls)
                .append(print_frame)
                .appendTo('body');
            // The frame lives
            for (var i=0; i < window.frames.length; i++) {
                if (window.frames[i].name == "print-frame") {    
                    var print_frame_ref = window.frames[i].document;
                    break;
                }
            }
            print_frame_ref.open();
            print_frame_ref.write('<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">' +
                '<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">' + 
                '<head></head>' +
                '<body></body>' +
                '</html>');
            print_frame_ref.close();
            // Grab contents and apply stylesheet
            var $iframe_head = $('head link[media*=print], head link[media=all]').clone(),
                $iframe_body = $('body > *:not(#print-modal):not(script)').clone();
            $iframe_head.each(function() {
                $(this).attr('media', 'all');
            });
            /*$('head', print_frame_ref).append($iframe_head);
            $('body', print_frame_ref).append($iframe_body);
*/
                $('body > *:not(#print-modal):not(script)').clone().each(function() {
                    $('body', print_frame_ref).append(this.outerHTML);
                });
                $('head link[media*=print], head link[media=all]').each(function() {
                    $('head', print_frame_ref).append($(this).clone().attr('media', 'all')[0].outerHTML);
                });

            // Disable all links
            $('a', print_frame_ref).bind('click.printPreview', function(e) {
                e.preventDefault();
            });

            // Introduce print styles
            $('head').append('<style type="text/css">' +
                '@media print {' +
                    '/* -- Print Preview --*/' +
                    '#print-modal-mask,' +
                    '#print-modal {' +
                        'display: none !important;' +
                    '}' +
                    '@page {' +  /* auto is the initial value */
                            'margin-top: 0;'+
                            'margin-bottom: 0;'+ /* this affects the margin in the printer settings */
                    '}'+
                    'body {' +
                        'margin-top: 100px;' +
                    '}'+
                    'body:before{'+
                        'margin-top: 100px;' +
                        'content:url("../img/logo.png");' +
                    '}' +
                    'nav {' +
                        'display: none;' +
                    '}' +
                '}' +
                '</style>'
            );
            // Load mask
            $.printPreview.loadMask();
            // Disable scrolling
            $('body').css({overflowY: 'hidden', height: '100%'});
            $('img', print_frame_ref).load(function() {
                print_frame.height($('body', print_frame.contents())[0].scrollHeight);
            });

            // Position modal            
            starting_position = $(window).height() + $(window).scrollTop();
            var css = {
                    top:         starting_position,
                    height:      '100%',
                    overflowY:   'auto',
                    zIndex:      10000,
                    display:     'block'
                }
            print_modal
                .css(css)
                .animate({ top: $(window).scrollTop()}, 400, 'linear', function() {
                    print_controls.fadeIn('slow').focus();
                });
            print_frame.height($('body', print_frame.contents())[0].scrollHeight);

            // Bind closure
            $('a', print_controls).bind('click', function(e) {
                e.preventDefault();
                if ($(this).hasClass('print')) { window.print(); }
                else { $.printPreview.distroyPrintPreview(); }
            });
        },

        distroyPrintPreview: function() {
            print_controls.fadeOut(100);
            print_modal.animate({ top: $(window).scrollTop() - $(window).height(), opacity: 1}, 400, 'linear', function(){
                print_modal.remove();
                $('body').css({overflowY: 'auto', height: 'auto'});
            });
            mask.fadeOut('slow', function()  {
                mask.remove();
            });             
            $(document).unbind("keydown.printPreview.mask");
            mask.unbind("click.printPreview.mask");
            $(window).unbind("resize.printPreview.mask");
        },

        /* -- Mask Functions --*/
        loadMask: function() {
            size = $.printPreview.sizeUpMask();
            mask = $('<div id="print-modal-mask" />').appendTo($('body'));
            mask.css({              
                position:           'absolute', 
                top:                0, 
                left:               0,
                width:              size[0],
                height:             size[1],
                display:            'none',
                opacity:            0,                          
                zIndex:             9999,
                backgroundColor:    '#000'
            });

            mask.css({display: 'block'}).fadeTo('400', 0.75);

            $(window).bind("resize..printPreview.mask", function() {
                $.printPreview.updateMaskSize();
            });

            mask.bind("click.printPreview.mask", function(e)  {
                $.printPreview.distroyPrintPreview();
            });

            $(document).bind("keydown.printPreview.mask", function(e) {
                if (e.keyCode == 27) {  $.printPreview.distroyPrintPreview(); }
            });
        },

        sizeUpMask: function() {
           // if ($.browser.msie) {
                // if there are no scrollbars then use window.height
                var d = $(document).height(), w = $(window).height();
                return [
                    window.innerWidth ||                        // ie7+
                    document.documentElement.clientWidth ||     // ie6  
                    document.body.clientWidth,                  // ie6 quirks mode
                    d - w < 20 ? w : d
                ];
           // } else { return [$(document).width(), $(document).height()]; }
        },

        updateMaskSize: function() {
            var size = $.printPreview.sizeUpMask();
            mask.css({width: size[0], height: size[1]});
        }
    }
})(jQuery);

    lanceImpression(e) {
        var ids = [];
        var tactac = "";
        tactac = "Filtres : ";
        $('.print').each(function() {
                if($(this).is(':checked')) {
                    _this.tactac = "";
                    ids.push($(this).attr('id'));
                }
                _this.tactac = "";
            });
        $('.print_select').each(function() {
                if($(this).is(':selected')) {
                    _this.tactac = "";
                    ids.push($(this).attr('id'));
                }
                console.log("tatatatata");
                _this.tactac = "";
            });
        $('.print_input_text').each(function() {
                if($(this).val()) {
                    _this.tactac = "";
                    ids.push($(this).attr('id'));
                }
                _this.tactac = "";
            });
        var i, d;
       for(i=0; i<ids.length; i++){
            if ($("#"+ids[i]).is( "option" ) ) {
                _this.tactac += $("#"+ids[i]).text() + "\n";
            } else {
                _this.tactac += $("#"+ids[i]).val() + "\n";
            }
        }
        _this.update();
        document.title = $("#entrepriseName").text();
        window.print();

    }
//// FIN FONCTION IMPRIMER

    </script>

</impressions>
